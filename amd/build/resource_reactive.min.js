define("mod_bookit/resource_reactive",["exports","core/reactive","core_form/modalform"],(function(_exports,_reactive,_modalform){var obj;
/**
   * Reactive store for resource catalog.
   *
   * @module mod_bookit/resource_reactive
   * @copyright   2026 ssystems GmbH <oss@ssystems.de>
   * @author      Andreas Rosenthal
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.createResourceReactive=void 0,_modalform=(obj=_modalform)&&obj.__esModule?obj:{default:obj};class ResourceMutations{prepareState(stateManager,data){const state=stateManager.state;state.categories||(state.categories=new Map),state.items||(state.items=new Map),data.categories&&data.categories.forEach((category=>{state.categories.set(category.id,{...category,id:parseInt(category.id,10)})})),data.items&&data.items.forEach((item=>{state.items.set(item.id,{...item,id:parseInt(item.id,10),categoryid:parseInt(item.categoryid,10)})}))}reOrderCategoryItems(stateManager,data){const state=stateManager.state;if(stateManager.setReadOnly(!1),data.parentId!==data.targetParentId){const sourceCategory=state.categories.get(data.parentId),targetCategory=state.categories.get(data.targetParentId);sourceCategory.items&&Array.isArray(sourceCategory.items)||(sourceCategory.items=[]),targetCategory.items&&Array.isArray(targetCategory.items)||(targetCategory.items=[]);const idToMove=parseInt(data.id,10),targetId=parseInt(data.targetId,10);sourceCategory.items=sourceCategory.items.filter((item=>item!==idToMove));const targetItems=[...targetCategory.items];if(-1===targetItems.indexOf(idToMove)){const targetIndex=targetItems.indexOf(targetId);-1!==targetIndex?targetItems.splice(targetIndex+1,0,idToMove):targetItems.push(idToMove)}targetCategory.items=targetItems;const targetItem=state.items.get(idToMove);targetItem&&(targetItem.categoryid=parseInt(targetCategory.id,10))}else{const category=state.categories.get(data.targetParentId);category.items&&Array.isArray(category.items)||(category.items=[]);const currentItems=[...category.items],idToMove=parseInt(data.id,10),targetId=parseInt(data.targetId,10),currentIndex=currentItems.indexOf(idToMove);-1===currentIndex&&currentItems.push(idToMove);if(-1!==currentItems.indexOf(targetId)&&-1!==currentIndex){currentItems.splice(currentIndex,1);const newTargetIndex=currentItems.indexOf(targetId);currentItems.splice(newTargetIndex+1,0,idToMove)}else-1!==currentIndex&&(currentItems.splice(currentIndex,1),currentItems.push(idToMove));category.items=currentItems}stateManager.setReadOnly(!0);const categoriesToUpdate=[];categoriesToUpdate.push(data.targetParentId),data.parentId!==data.targetParentId&&categoriesToUpdate.push(data.parentId),categoriesToUpdate.forEach((categoryId=>{const category=state.categories.get(categoryId),mutationData={formData:{id:category.id,name:category.name,description:category.description||"",items:category.items||[],action:"put"},formType:"category"};this._callDynamicForm(stateManager,mutationData,!1)}))}reOrderCategories(stateManager,data){const state=stateManager.state;let categoryOrder=Array.from(state.categories.keys()).sort(((a,b)=>{const catA=state.categories.get(a),catB=state.categories.get(b);return(catA.sortorder||0)-(catB.sortorder||0)}));const idToMove=parseInt(data.id,10),targetId=parseInt(data.targetId,10);categoryOrder=categoryOrder.filter((id=>id!==idToMove));const targetIndex=categoryOrder.indexOf(targetId);-1!==targetIndex?categoryOrder.splice(targetIndex+1,0,idToMove):categoryOrder.push(idToMove);const formDataObj={id:0,categoryorder:categoryOrder.join(","),action:"put"};data.formData=formDataObj,data.formType="category",this._callDynamicForm(stateManager,data)}createCategory(stateManager,data){stateManager.setReadOnly(!1);const newCategory={id:parseInt(data.id,10),name:data.name,description:data.description||"",sortorder:data.sortorder||0,active:void 0===data.active||data.active,items:[]};stateManager.state.categories.set(newCategory.id,newCategory),stateManager.setReadOnly(!0)}updateCategory(stateManager,data){stateManager.setReadOnly(!1);const category=stateManager.state.categories.get(parseInt(data.id,10));category&&(category.name=data.name,category.description=data.description||"",category.sortorder=data.sortorder||category.sortorder,category.active=void 0!==data.active?data.active:category.active),stateManager.setReadOnly(!0)}deleteCategory(stateManager,categoryId){stateManager.setReadOnly(!1);const category=stateManager.state.categories.get(categoryId);category&&category.items&&category.items.forEach((itemId=>{stateManager.state.items.delete(itemId)})),stateManager.state.categories.delete(categoryId),stateManager.setReadOnly(!0)}createItem(stateManager,data){stateManager.setReadOnly(!1);const newItem={id:parseInt(data.id,10),categoryid:parseInt(data.categoryid,10),name:data.name,description:data.description||"",amount:data.amount||0,amountirrelevant:void 0!==data.amountirrelevant&&data.amountirrelevant,sortorder:data.sortorder||0,active:void 0===data.active||data.active};stateManager.state.items.set(newItem.id,newItem);const category=stateManager.state.categories.get(newItem.categoryid);category&&(category.items||(category.items=[]),category.items.push(newItem.id)),stateManager.setReadOnly(!0)}updateItem(stateManager,data){stateManager.setReadOnly(!1);const item=stateManager.state.items.get(parseInt(data.id,10));if(item){const oldCategoryId=item.categoryid,newCategoryId=parseInt(data.categoryid,10);if(item.name=data.name,item.description=data.description||"",item.amount=data.amount||0,item.amountirrelevant=void 0!==data.amountirrelevant&&data.amountirrelevant,item.sortorder=data.sortorder||item.sortorder,item.active=void 0!==data.active?data.active:item.active,item.categoryid=newCategoryId,oldCategoryId!==newCategoryId){const oldCategory=stateManager.state.categories.get(oldCategoryId),newCategory=stateManager.state.categories.get(newCategoryId);oldCategory&&oldCategory.items&&(oldCategory.items=oldCategory.items.filter((id=>id!==item.id))),newCategory&&(newCategory.items||(newCategory.items=[]),newCategory.items.push(item.id))}}stateManager.setReadOnly(!0)}deleteItem(stateManager,itemId){stateManager.setReadOnly(!1);const item=stateManager.state.items.get(itemId);if(item){const category=stateManager.state.categories.get(item.categoryid);category&&category.items&&(category.items=category.items.filter((id=>id!==itemId))),stateManager.state.items.delete(itemId)}stateManager.setReadOnly(!0)}_callDynamicForm(stateManager,data){let showModal=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const formClass=this._getFormClass(data.formType),modalForm=new _modalform.default({formClass:formClass,args:data.formData,modalConfig:{title:""},saveButtonText:""});return showModal?(modalForm.show(),Promise.resolve()):modalForm.processNoSubmitButton().then((()=>(window.console.log("Form submitted:",data.formType,data.formData),!0))).catch((error=>{throw window.console.error("Form submission failed:",error),error}))}_getFormClass(formType){switch(formType){case"category":return"mod_bookit\\form\\edit_resource_category_form";case"item":return"mod_bookit\\form\\edit_resource_form";default:throw new Error("Unknown form type: ".concat(formType))}}}_exports.createResourceReactive=initialData=>{const mutations=new ResourceMutations,reactive=new _reactive.Reactive({name:"mod_bookit-resource_catalog",eventName:"resourceCatalogUpdated",eventDispatch:()=>{},mutations:mutations,state:{categories:new Map,items:new Map}});return reactive.stateReady.then((()=>(mutations.prepareState(reactive,initialData),!0))).catch((error=>{throw window.console.error("Error initializing reactive state:",error),error})),reactive}}));

//# sourceMappingURL=resource_reactive.min.js.map