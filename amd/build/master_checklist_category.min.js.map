{"version":3,"file":"master_checklist_category.min.js","sources":["../src/master_checklist_category.js"],"sourcesContent":["import { BaseComponent, DragDrop } from 'core/reactive';\nimport { masterChecklistReactiveInstance } from 'mod_bookit/master_checklist_reactive';\nimport { SELECTORS } from 'mod_bookit/master_checklist_reactive';\nimport ModalForm from 'core_form/modalform';\nimport Templates from 'core/templates';\nimport {getString} from 'core/str';\n\nexport default class extends BaseComponent {\n\n    create(descriptor) {\n\n        window.console.log('create category component: ' + descriptor.element.dataset.bookitCategoryName);\n        window.console.log(descriptor.element.dataset);\n\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + descriptor.element.dataset.bookitCategoryId;\n\n        this.selectors[categoryEditBtnSelector] = `#edit-checklistcategory-${descriptor.element.dataset.bookitCategoryId}`;\n\n        const categoryTbodySelector = 'CATEGORY_TBODY_' + descriptor.element.dataset.bookitCategoryId;\n        this.selectors[categoryTbodySelector] = `#bookit-master-checklist-tbody-category-${descriptor.element.dataset.bookitCategoryId}`;\n\n        window.console.log(this.selectors);\n\n//         document.addEventListener('categoryRendered', (e) => {\n//     window.console.log('ðŸ”¥ caught event on document:', e.detail);\n// }, true);\n\n    }\n\n    static init(target, selectors) {\n        return new this({\n            element: document.querySelector(target),\n            reactive: masterChecklistReactiveInstance,\n            selectors: selectors || SELECTORS,\n        });\n    }\n\n    getWatchers() {\n        return [\n            {watch: 'checklistcategories.name:updated', handler: this._refreshEditButtonListener},\n            {watch: 'mod_bookit:master_checklist_category_rendered', handler: this._foo},\n            // {watch: 'state:updated', handler: this._handleStateEvent},\n            // {watch: 'checklistcategories:created', handler: this._handleCategoryCreatedEvent},\n        ];\n    }\n\n    stateReady(state) {\n        window.console.log(this.element.dataset);\n\n        this.dragdrop = new DragDrop(this);\n\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\n\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\n            e.preventDefault();\n            window.console.log('EDIT CHECKLIST CATEGORY BUTTON CLICKED', e.currentTarget);\n            this._handleEditChecklistCategoryButtonClick(e);\n        });\n\n        const categoryTbodySelector = 'CATEGORY_TBODY_' + this.element.dataset.bookitCategoryId;\n\n        const elem = document.querySelector(this.selectors.MAIN_ELEMENT);\n        window.console.log('elem:', elem);\n\n        // this.addEventListener(document.querySelector(this.selectors.MAIN_ELEMENT), 'mod_bookit:master_checklist_category_rendered', (e) => {\n        //     window.console.log('category rendered event received in component');\n        //     window.console.log(e);\n        //     this._foo(e);\n        // });\n\n        document.addEventListener('mod_bookit:master_checklist_category_rendered', (e) => {\n            window.console.log('NOW THIS', e.detail);\n            this._refreshEditButtonListener(e);\n        }, true);\n    }\n\n    destroy() {\n        if (this.dragdrop !== undefined) {\n            this.dragdrop.unregister();\n        }\n    }\n\n    validateDropData(dropdata) {\n\n        return true;\n    }\n\n    async _handleEditChecklistCategoryButtonClick(event) {\n        window.console.log('handle edit checklist category button click');\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\form\\\\edit_checklist_category_form',\n            moduleName: 'mod_bookit/modal_delete_save_cancel',\n            args: {\n                id: this.element.dataset.bookitCategoryId,\n                masterid: 1,\n                checklistitems: JSON.stringify(this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId).items),\n            },\n            modalConfig: {\n                title: await getString('checklistcategory', 'mod_bookit'),\n            },\n        })\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (response) => {\n            this.reactive.stateManager.processUpdates(response.detail);\n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, (response) => {\n\n            const deleteButton = modalForm.modal.getRoot().find('button[data-action=\"delete\"]');\n\n            deleteButton.on('click', (e) => {\n                modalForm.getFormNode().querySelector('input[name=\"action\"]').value = 'delete';\n                modalForm.submitFormAjax();\n            });\n        });\n\n        modalForm.show();\n    };\n\n    _refreshEditButtonListener(event) {\n        window.console.log('handle category updated event in component');\n        window.console.log(event);\n\n        this.removeAllEventListeners();\n\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\n\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\n            e.preventDefault();\n            window.console.log('EDIT CHECKLIST CATEGORY BUTTON CLICKED', e.currentTarget);\n            this._handleEditChecklistCategoryButtonClick(e);\n        });\n    }\n\n    drop(dropdata, event) {\n        switch (dropdata.type) {\n            case 'item':\n                this._handleItemDrop(dropdata, event);\n                break;\n            case 'category':\n                this._handleCategoryDrop(dropdata, event);\n                break;\n            default:\n                throw new Error(`Unknown drop type: ${dropdata.type}`);\n        }\n    }\n\n    showDropZone(dropdata, event) {\n        const root = document.querySelector('html');\n        const primaryColor = getComputedStyle(root).getPropertyValue('--primary');\n\n        window.console.log('primary color: ', primaryColor);\n\n        this.element.style.boxShadow = `0px -5px 0px 0px ${primaryColor} inset`;\n        this.element.style.transition = 'box-shadow 0.1s ease';\n    }\n\n    hideDropZone(dropdata, event) {\n        this.element.style.boxShadow = '';\n        this.element.style.backgroundBlendMode = '';\n        this.element.style.transition = '';\n    }\n\n    _handleItemDrop(dropdata, event) {\n        window.console.log('handle item drop on category');\n        // window.console.log(dropdata);\n        window.console.log(event);\n\n        const categoryObject = this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId);\n\n        const categoryObjectItems = [...categoryObject.items];\n\n        const lastItemId = categoryObjectItems[categoryObjectItems.length - 1];\n\n        dropdata.targetId = parseInt(lastItemId);\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryId);\n\n        this.reactive.dispatch('reOrderCategoryItems', dropdata);\n\n        const itemObject = this.reactive.state.checklistitems.get(dropdata.id);\n\n        const itemElement = document.getElementById(`bookit-master-checklist-item-${itemObject.id}`);\n\n        const itemHasChangedParent = dropdata.parentId !== dropdata.targetParentId;\n\n        if (itemHasChangedParent) {\n            itemElement.dataset.bookitChecklistitemCategoryid = dropdata.targetParentId;\n        }\n\n        this.element.append(itemElement);\n    }\n\n\n    _handleCategoryDrop(dropdata, event) {\n        window.console.log('handle category drop on category');\n        window.console.log(event);\n\n        dropdata.targetId = parseInt(this.element.dataset.bookitCategoryId);\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryMasterid);\n        window.console.log(`whoops you dropped an ${dropdata.type} on a category`, dropdata);\n\n        this.reactive.dispatch('reOrderCategories', dropdata);\n\n        const categoryObject = this.reactive.state.checklistcategories.get(dropdata.id);\n\n        const categoryElement = document.getElementById(`bookit-master-checklist-tbody-category-${categoryObject.id}`);\n\n        // this.element.parentNode.append(categoryElement);\n        const tableElement = document.querySelector(this.selectors.TABLE);\n\n        tableElement.insertBefore(categoryElement, this.element.nextElementSibling);\n\n    }\n\n    _foo(event) {\n        window.console.log('foo');\n        window.console.log(event);\n    }\n\n}"],"names":["BaseComponent","create","descriptor","window","console","log","element","dataset","bookitCategoryName","categoryEditBtnSelector","bookitCategoryId","selectors","categoryTbodySelector","this","target","document","querySelector","reactive","masterChecklistReactiveInstance","SELECTORS","getWatchers","watch","handler","_refreshEditButtonListener","_foo","stateReady","state","dragdrop","DragDrop","addEventListener","getElement","e","preventDefault","currentTarget","_handleEditChecklistCategoryButtonClick","elem","MAIN_ELEMENT","detail","destroy","undefined","unregister","validateDropData","dropdata","event","modalForm","ModalForm","formClass","moduleName","args","id","masterid","checklistitems","JSON","stringify","checklistcategories","get","items","modalConfig","title","events","FORM_SUBMITTED","response","stateManager","processUpdates","LOADED","modal","getRoot","find","on","getFormNode","value","submitFormAjax","show","removeAllEventListeners","drop","type","_handleItemDrop","_handleCategoryDrop","Error","showDropZone","root","primaryColor","getComputedStyle","getPropertyValue","style","boxShadow","transition","hideDropZone","backgroundBlendMode","categoryObjectItems","lastItemId","length","targetId","parseInt","targetParentId","dispatch","itemObject","itemElement","getElementById","parentId","bookitChecklistitemCategoryid","append","bookitCategoryMasterid","categoryObject","categoryElement","TABLE","insertBefore","nextElementSibling"],"mappings":"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"}