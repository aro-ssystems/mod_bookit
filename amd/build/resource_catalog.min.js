define("mod_bookit/resource_catalog",["exports","core/reactive","./resource_reactive","core_form/modalform","core/str","core/notification","./resource_category"],(function(_exports,_reactive,_resource_reactive,_modalform,_str,_notification,_resource_category){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Resource catalog reactive component.
   *
   * @module mod_bookit/resource_catalog
   * @copyright   2026 ssystems GmbH <oss@ssystems.de>
   * @author      Andreas Rosenthal
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_modalform=_interopRequireDefault(_modalform),_notification=_interopRequireDefault(_notification),_resource_category=_interopRequireDefault(_resource_category);class _default extends _reactive.BaseComponent{static init(target){const element=document.querySelector(target);if(!element)return null;const contextId=parseInt(element.dataset.contextid),categoriesArray=[],itemsArray=[];return element.querySelectorAll('[data-region="resource-category"]').forEach((categoryEl=>{const categoryRow=categoryEl.querySelector('[data-region="resource-category-row"]'),categoryData={id:parseInt(categoryEl.dataset.categoryid),name:categoryEl.dataset.categoryName||(null==categoryRow?void 0:categoryRow.textContent.trim()),description:categoryEl.dataset.categoryDescription||"",sortorder:parseInt(categoryEl.dataset.categorySortorder)||0};categoriesArray.push(categoryData);categoryEl.querySelectorAll('[data-region="resource-item-row"]').forEach((itemEl=>{const itemData={id:parseInt(itemEl.dataset.itemid),name:itemEl.dataset.itemName||"",description:itemEl.dataset.itemDescription||"",categoryid:parseInt(itemEl.dataset.itemCategoryid),amount:parseInt(itemEl.dataset.itemAmount)||0,amountirrelevant:"true"===itemEl.dataset.itemAmountirrelevant,sortorder:parseInt(itemEl.dataset.itemSortorder)||0};itemsArray.push(itemData)}))})),(0,_resource_reactive.initResourceReactive)({categories:categoriesArray,items:itemsArray}),new this({element:element,reactive:_resource_reactive.resourceReactiveInstance,selectors:{contextId:contextId}})}static get componentName(){return"mod_bookit/resource_catalog"}create(){this.selectors.addCategoryBtn="#add-category-btn",this.selectors.addResourceBtn="#add-resource-btn",this.selectors.tableView="#mod-bookit-resource-table-view",this.categoryComponents=new Map}stateReady(){this._initializeCategoryComponents(),this._attachEventListeners()}getWatchers(){return[{watch:"categories:created",handler:this._handleCategoryCreated},{watch:"categories.name:updated",handler:this._handleCategoryUpdated},{watch:"categories.description:updated",handler:this._handleCategoryUpdated},{watch:"categories:deleted",handler:this._handleCategoryDeleted},{watch:"items:created",handler:this._handleItemCreated},{watch:"items.name:updated",handler:this._replaceRenderedItem},{watch:"items.description:updated",handler:this._replaceRenderedItem},{watch:"items.amount:updated",handler:this._replaceRenderedItem},{watch:"items.amountirrelevant:updated",handler:this._replaceRenderedItem},{watch:"items.active:updated",handler:this._replaceRenderedItem}]}_handleCategoryCreated(_ref){let{element:element}=_ref;this._renderCategory(element)}_handleCategoryUpdated(_ref2){let{element:element}=_ref2;const component=this.categoryComponents.get(element.id);component&&component.update(element)}_handleCategoryDeleted(_ref3){let{element:element}=_ref3;const component=this.categoryComponents.get(element.id);component&&(component.remove(),this.categoryComponents.delete(element.id))}_handleItemCreated(){}_replaceRenderedItem(event){const fieldPart=event.action.split(".")[1].split(":")[0];if("amount"===fieldPart||"amountirrelevant"===fieldPart){const targetElement=document.querySelector('td[data-bookit-resource-tabledata-amount-id="'.concat(event.element.id,'"]'));if(targetElement){const item=this.reactive.state.items.get(event.element.id);item.amountirrelevant?targetElement.innerHTML='<span class="badge badge-secondary">Unlimited</span>':targetElement.innerHTML='<span class="badge badge-info">'.concat(item.amount,"x</span>")}}else if("active"===fieldPart){const targetElement=document.querySelector('td[data-bookit-resource-tabledata-active-id="'.concat(event.element.id,'"]'));if(targetElement){this.reactive.state.items.get(event.element.id).active?targetElement.innerHTML='<span class="badge badge-success">Active</span>':targetElement.innerHTML='<span class="badge badge-secondary">Inactive</span>'}}else{const elementSelector="span[data-bookit-resource-tabledata-".concat(fieldPart,'-id="').concat(event.element.id,'"]'),targetElement=document.querySelector(elementSelector);targetElement&&(targetElement.innerHTML=event.element[fieldPart])}}_attachEventListeners(){const addBtn=document.querySelector(this.selectors.addCategoryBtn);addBtn&&addBtn.addEventListener("click",(e=>{e.preventDefault(),this._handleAddCategory()}));const addResourceBtn=document.querySelector(this.selectors.addResourceBtn);addResourceBtn&&addResourceBtn.addEventListener("click",(e=>{e.preventDefault(),this._handleAddResource()})),this._attachTableViewEventListeners()}_attachTableViewEventListeners(){const tableView=document.querySelector(this.selectors.tableView);tableView&&tableView.addEventListener("click",(async e=>{const target=e.target.closest("button[data-action]");if(!target)return;const action=target.dataset.action;switch(e.preventDefault(),action){case"edit-category":await this._handleEditCategoryFromTable(target);break;case"edit-item":await this._handleEditItemFromTable(target)}}))}async _handleEditCategoryFromTable(button){const categoryId=parseInt(button.dataset.categoryId);if(!this.reactive.state.categories.get(categoryId))return;const modalForm=new _modalform.default({formClass:"mod_bookit\\form\\edit_resource_category_form",moduleName:"mod_bookit/modal_delete_save_cancel",args:{id:categoryId},modalConfig:{title:await(0,_str.get_string)("resources:edit_category","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.stateManager.processUpdates(response.detail)})),modalForm.addEventListener(modalForm.events.LOADED,(()=>{modalForm.modal.getRoot().find('button[data-action="delete"]').on("click",(async e=>{e.preventDefault();const state=this.reactive.state;if(Array.from(state.items.values()).filter((item=>item.categoryid===categoryId)).length>0){const errorTitle=await(0,_str.get_string)("error","core"),errorMessage=await(0,_str.get_string)("resources:category_has_resources","mod_bookit");return void _notification.default.alert(errorTitle,errorMessage)}const confirmTitle=await(0,_str.get_string)("confirm","core"),confirmMessage=await(0,_str.get_string)("areyousure","core"),deleteText=await(0,_str.get_string)("delete","core");_notification.default.deleteCancel(confirmTitle,confirmMessage,deleteText,(()=>{modalForm.getFormNode().querySelector('input[name="action"]').value="delete",modalForm.submitFormAjax()}))}))})),modalForm.show()}async _handleEditItemFromTable(button){const itemId=parseInt(button.dataset.itemId);if(!this.reactive.state.items.get(itemId))return;const modalForm=new _modalform.default({formClass:"mod_bookit\\form\\edit_resource_form",moduleName:"mod_bookit/modal_delete_save_cancel",args:{id:itemId},modalConfig:{title:await(0,_str.get_string)("resources:edit_resource","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.stateManager.processUpdates(response.detail)})),modalForm.addEventListener(modalForm.events.LOADED,(()=>{modalForm.modal.getRoot().find('button[data-action="delete"]').on("click",(async e=>{e.preventDefault();const confirmTitle=await(0,_str.get_string)("confirm","core"),confirmMessage=await(0,_str.get_string)("areyousure","core"),deleteText=await(0,_str.get_string)("delete","core");_notification.default.deleteCancel(confirmTitle,confirmMessage,deleteText,(()=>{modalForm.getFormNode().querySelector('input[name="action"]').value="delete",modalForm.submitFormAjax()}))}))})),modalForm.show()}async _handleAddCategory(){const modalForm=new _modalform.default({formClass:"mod_bookit\\form\\edit_resource_category_form",args:{contextid:this.selectors.contextId},modalConfig:{title:await(0,_str.get_string)("resources:add_category","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.stateManager.processUpdates(response.detail)})),modalForm.show()}async _handleAddResource(){const modalForm=new _modalform.default({formClass:"mod_bookit\\form\\edit_resource_form",args:{contextid:this.selectors.contextId},modalConfig:{title:await(0,_str.get_string)("resources:add_resource","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.stateManager.processUpdates(response.detail)})),modalForm.show()}_showNoCategoriesMessage(){const msg=document.querySelector(this.selectors.noCategoriesMsg);msg&&msg.classList.remove("d-none")}_hideNoCategoriesMessage(){const msg=document.querySelector(this.selectors.noCategoriesMsg);msg&&msg.classList.add("d-none")}_initializeCategoryComponents(){const categoryElements=this.element.querySelectorAll('[data-region="resource-category"]'),state=this.reactive.state;categoryElements.forEach((categoryEl=>{const categoryId=parseInt(categoryEl.dataset.categoryid),category=state.categories.get(categoryId);if(category){const component=new _resource_category.default({element:this.element.querySelector("#mod-bookit-resource-table"),reactive:this.reactive,categoryData:category});component.categoryElement&&component.categoryElement.remove(),component.categoryElement=categoryEl,component._attachEventListeners(),this.categoryComponents.set(categoryId,component)}}))}_renderCategory(categoryData){const tableEl=this.element.querySelector("#mod-bookit-resource-table");if(!tableEl)return;const component=new _resource_category.default({element:tableEl,reactive:this.reactive,categoryData:categoryData});this.categoryComponents.set(categoryData.id,component)}}return _exports.default=_default,_exports.default}));

//# sourceMappingURL=resource_catalog.min.js.map