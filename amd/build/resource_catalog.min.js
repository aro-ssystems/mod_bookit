define("mod_bookit/resource_catalog",["exports","core/reactive","./resource_reactive","core_form/modalform","core/str","core/ajax","./resource_category"],(function(_exports,_reactive,_resource_reactive,_modalform,_str,_ajax,_resource_category){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Resource catalog reactive component.
   *
   * @module mod_bookit/resource_catalog
   * @copyright   2026 ssystems GmbH <oss@ssystems.de>
   * @author      Andreas Rosenthal
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_modalform=_interopRequireDefault(_modalform),_ajax=_interopRequireDefault(_ajax),_resource_category=_interopRequireDefault(_resource_category);class _default extends _reactive.BaseComponent{static init(target){const element=document.querySelector(target);if(!element)return null;const contextId=parseInt(element.dataset.contextid),categoriesArray=[],itemsArray=[];return element.querySelectorAll('[data-region="resource-category"]').forEach((categoryEl=>{const categoryRow=categoryEl.querySelector('[data-region="resource-category-row"]'),categoryData={id:parseInt(categoryEl.dataset.categoryid),name:categoryEl.dataset.categoryName||(null==categoryRow?void 0:categoryRow.textContent.trim()),description:categoryEl.dataset.categoryDescription||"",sortorder:parseInt(categoryEl.dataset.categorySortorder)||0};categoriesArray.push(categoryData);categoryEl.querySelectorAll('[data-region="resource-item-row"]').forEach((itemEl=>{let roomids=[];if(itemEl.dataset.itemRoomids)try{roomids=JSON.parse(itemEl.dataset.itemRoomids),Array.isArray(roomids)||(roomids=[])}catch(e){window.console.warn("Failed to parse roomids:",e),roomids=[]}const itemData={id:parseInt(itemEl.dataset.itemid),name:itemEl.dataset.itemName||"",description:itemEl.dataset.itemDescription||"",categoryid:parseInt(itemEl.dataset.itemCategoryid),amount:parseInt(itemEl.dataset.itemAmount)||0,amountirrelevant:"1"===itemEl.dataset.itemAmountirrelevant,active:"1"===itemEl.dataset.itemActive,sortorder:parseInt(itemEl.dataset.itemSortorder)||0,roomids:roomids};itemsArray.push(itemData)}))})),(0,_resource_reactive.initResourceReactive)({categories:categoriesArray,items:itemsArray}),new this({element:element,reactive:_resource_reactive.resourceReactiveInstance,selectors:{contextId:contextId}})}static get componentName(){return"mod_bookit/resource_catalog"}create(){this.selectors.addCategoryBtn="#add-category-btn",this.selectors.addResourceBtn="#add-resource-btn",this.selectors.tableView="#mod-bookit-resource-table-view",this.selectors.roomFilter="#id_roomfilter_filter_section",this.categoryComponents=new Map,this.selectedRooms=new Set,this.strings={},(0,_str.get_string)("active","core").then((str=>(this.strings.active=str,str))).catch((()=>{this.strings.active="Active"})),(0,_str.get_string)("inactive","core").then((str=>(this.strings.inactive=str,str))).catch((()=>{this.strings.inactive="Inactive"}))}stateReady(){this._initializeCategoryComponents(),this._attachEventListeners(),this._initializeRoomFilter()}getWatchers(){return[{watch:"categories:created",handler:this._handleCategoryCreated},{watch:"categories.name:updated",handler:this._handleCategoryUpdated},{watch:"categories.description:updated",handler:this._handleCategoryUpdated},{watch:"categories:deleted",handler:this._handleCategoryDeleted},{watch:"items:created",handler:this._handleItemCreated},{watch:"items.active:updated",handler:this._handleActiveToggle},{watch:"items.name:updated",handler:this._replaceRenderedItem},{watch:"items.description:updated",handler:this._replaceRenderedItem},{watch:"items.amount:updated",handler:this._replaceRenderedItem},{watch:"items.amountirrelevant:updated",handler:this._replaceRenderedItem},{watch:"items.roomids:updated",handler:this._handleRoomidsUpdated},{watch:"items.roomnames:updated",handler:this._handleRoomnamesUpdated}]}async _handleCategoryCreated(_ref){let{element:element}=_ref;await this._renderCategory(element)}_handleCategoryUpdated(_ref2){let{element:element}=_ref2;const component=this.categoryComponents.get(element.id);component&&component.update(element)}_handleCategoryDeleted(_ref3){let{element:element}=_ref3;const component=this.categoryComponents.get(element.id);component&&(component.remove(),this.categoryComponents.delete(element.id))}_handleItemCreated(){}_handleActiveToggle(_ref4){let{element:element}=_ref4;const checkbox=document.querySelector("#resource-active-".concat(element.id));if(!checkbox)return void window.console.warn("Toggle checkbox not found for item ".concat(element.id));checkbox.checked=element.active;const label=document.querySelector('label[for="resource-active-'.concat(element.id,'"]'));label&&(label.textContent=element.active?this.strings.active||"Active":this.strings.inactive||"Inactive");const row=document.querySelector("#resource-item-row-".concat(element.id));row&&row.classList.toggle("opacity-50",!element.active)}async _replaceRenderedItem(event){const fieldPart=event.action.split(".")[1].split(":")[0],item=this.reactive.state.items.get(event.element.id);if("amount"===fieldPart||"amountirrelevant"===fieldPart){const amountCell=document.querySelector('td[data-bookit-resource-tabledata-amount-id="'.concat(item.id,'"]'));if(!amountCell)return;item.amountirrelevant?amountCell.innerHTML='<span class="badge badge-secondary">Unlimited</span>':amountCell.innerHTML='<span class="badge badge-info">'.concat(item.amount,"x</span>")}else if("name"===fieldPart){const nameSpan=document.querySelector('span[data-bookit-resource-tabledata-name-id="'.concat(item.id,'"]'));if(!nameSpan)return;nameSpan.textContent=item.name}else"description"===fieldPart&&await this._updateDescriptionField(item)}async _updateDescriptionField(item){const descSpan=document.querySelector('small[data-bookit-resource-tabledata-description-id="'.concat(item.id,'"]'));if(descSpan)return void(descSpan.innerHTML=item.description||"");if(!item.description)return;if(!document.querySelector("#resource-item-row-".concat(item.id)))return;const categoryComponent=Array.from(this.categoryComponents.values()).find((cat=>cat.categoryData.id===item.categoryid));if(categoryComponent)try{await categoryComponent._renderItems()}catch(error){window.console.error("Failed to re-render items:",error)}}_handleRoomnamesUpdated(event){const item=this.reactive.state.items.get(event.element.id);if(!item)return;const roomsCell=document.querySelector('td[data-bookit-resource-tabledata-roomids-id="'.concat(item.id,'"]'));if(!roomsCell)return;roomsCell.innerHTML='<div class="d-flex flex-wrap align-items-center"></div>';const container=roomsCell.querySelector("div");item.roomnames&&0!==item.roomnames.length?item.roomnames.forEach((room=>{const badge=document.createElement("span");badge.className="badge ".concat(room.textclass," mr-1 mb-1"),badge.style.opacity="0.8",badge.style.backgroundColor=room.eventcolor,badge.dataset.bookitResourceTabledataRoomColor=room.eventcolor,badge.dataset.bookitResourceTabledataRoomTextclass=room.textclass,badge.dataset.bookitResourceTabledataRoomId=room.roomid,badge.dataset.bookitResourceRoomname=room.roomname,badge.dataset.bookitResourceTabledataIsRoomElement="",badge.textContent=room.roomname,container.appendChild(badge)})):container.innerHTML='<span class="badge badge-secondary">All rooms</span>'}_handleRoomidsUpdated(event){const item=this.reactive.state.items.get(event.element.id);if(!item)return;const row=document.querySelector('tr[data-bookit-item-id="'.concat(item.id,'"]'));row&&(row.dataset.itemRoomids=JSON.stringify(item.roomids||[]),row.dataset.rooms=JSON.stringify(item.roomids||[]))}_attachEventListeners(){const addBtn=document.querySelector(this.selectors.addCategoryBtn);addBtn&&addBtn.addEventListener("click",(e=>{e.preventDefault(),this._handleAddCategory()}));const addResourceBtn=document.querySelector(this.selectors.addResourceBtn);addResourceBtn&&addResourceBtn.addEventListener("click",(e=>{e.preventDefault(),this._handleAddResource()}));const tableView=document.querySelector(this.selectors.tableView);tableView&&tableView.addEventListener("change",(async e=>{const toggle=e.target.closest('[data-action="toggle-active"]');toggle&&await this._handleToggleActive(toggle)}))}async _handleAddCategory(){const modalForm=new _modalform.default({formClass:"mod_bookit\\form\\edit_resource_category_form",args:{contextid:this.selectors.contextId},modalConfig:{title:await(0,_str.get_string)("resources:add_category","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.stateManager.processUpdates(response.detail)})),modalForm.show()}async _handleAddResource(){const modalForm=new _modalform.default({formClass:"mod_bookit\\form\\edit_resource_form",args:{contextid:this.selectors.contextId},modalConfig:{title:await(0,_str.get_string)("resources:add_resource","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{this.reactive.stateManager.processUpdates(response.detail)})),modalForm.show()}async _handleToggleActive(checkbox){const itemId=parseInt(checkbox.dataset.itemId),item=this.reactive.state.items.get(itemId);if(!item)return;const newActiveState=checkbox.checked,formData={id:itemId,name:item.name,description:item.description||"",categoryid:item.categoryid,amount:item.amount,amountirrelevant:item.amountirrelevant?1:0,sortorder:item.sortorder,active:newActiveState?1:0,action:"put",_qf__mod_bookit_form_edit_resource_form:1},params=new URLSearchParams(formData);(item.roomids||[]).forEach((roomid=>{params.append("roomids[]",roomid)}));const formDataString=params.toString();try{const response=await _ajax.default.call([{methodname:"core_form_dynamic_form",args:{formdata:formDataString,form:"mod_bookit\\form\\edit_resource_form"}}])[0];this.reactive.stateManager.processUpdates(JSON.parse(response.data))}catch(error){checkbox.checked=!newActiveState,window.console.error("Toggle active error:",error)}}_showNoCategoriesMessage(){const msg=document.querySelector(this.selectors.noCategoriesMsg);msg&&msg.classList.remove("d-none")}_hideNoCategoriesMessage(){const msg=document.querySelector(this.selectors.noCategoriesMsg);msg&&msg.classList.add("d-none")}_initializeCategoryComponents(){const categoryElements=this.element.querySelectorAll('[data-region="resource-category"]'),state=this.reactive.state;categoryElements.forEach((categoryEl=>{const categoryId=parseInt(categoryEl.dataset.categoryid),category=state.categories.get(categoryId);if(category){const component=new _resource_category.default({element:this.element.querySelector("#mod-bookit-resource-table"),reactive:this.reactive,categoryData:category});component.categoryElement=categoryEl,component._attachEventListeners(),component._initItemsFromDOM(),this.categoryComponents.set(categoryId,component)}}))}async _renderCategory(categoryData){const tableEl=this.element.querySelector("#mod-bookit-resource-table");if(!tableEl)return;const component=new _resource_category.default({element:tableEl,reactive:this.reactive,categoryData:categoryData});await component._render(),this.categoryComponents.set(categoryData.id,component)}_initializeRoomFilter(){const filterContainer=this.element.querySelector(this.selectors.roomFilter);if(!filterContainer)return;const selectedRow=filterContainer.querySelector('[data-row="selected"]'),unselectedRow=filterContainer.querySelector('[data-row="unselected"]');selectedRow&&unselectedRow&&(this.addEventListener(selectedRow,"click",(e=>{if(!e.target.matches("button")&&!e.target.closest("button"))return;const button=e.target.closest("button");this._toggleFilterButton(button,selectedRow,unselectedRow),this._applyFilter()})),this.addEventListener(unselectedRow,"click",(e=>{if(!e.target.matches("button")&&!e.target.closest("button"))return;const button=e.target.closest("button");this._toggleFilterButton(button,selectedRow,unselectedRow),this._applyFilter()})))}_toggleFilterButton(button,selectedRow,unselectedRow){const value=button.dataset.value,isPressed="true"===button.getAttribute("aria-pressed"),icon=button.querySelector(".filter-icon"),filterSection=button.closest(".filter-section"),hiddenSelect=filterSection?filterSection.querySelector("select[multiple]"):null;if(isPressed){if(button.setAttribute("aria-pressed","false"),icon&&(icon.textContent="+"),this.selectedRooms.delete(value),unselectedRow.appendChild(button),hiddenSelect){const option=hiddenSelect.querySelector('option[value="'.concat(value,'"]'));option&&(option.selected=!1)}}else if(button.setAttribute("aria-pressed","true"),icon&&(icon.textContent="âœ“"),this.selectedRooms.add(value),selectedRow.appendChild(button),hiddenSelect){const option=hiddenSelect.querySelector('option[value="'.concat(value,'"]'));option&&(option.selected=!0)}}_applyFilter(){const allCategories=this.element.querySelectorAll('[data-region="resource-category"]');this.selectedRooms.size>0?allCategories.forEach((category=>{const resourceRows=category.querySelectorAll('[data-region="resource-item-row"]');let hasVisibleResources=!1;resourceRows.forEach((row=>{const resourceRooms=this._getResourceRooms(row);this._hasMatchingRoom(resourceRooms)?(row.style.display="",hasVisibleResources=!0):row.style.display="none"})),category.style.display=hasVisibleResources?"":"none"})):allCategories.forEach((category=>{category.style.display="";category.querySelectorAll('[data-region="resource-item-row"]').forEach((row=>{row.style.display=""}))}))}_getResourceRooms(row){const roomsData=row.dataset.rooms;if(!roomsData)return[];try{return JSON.parse(roomsData)}catch(e){return[]}}_hasMatchingRoom(resourceRooms){return 0!==resourceRooms.length&&resourceRooms.some((roomId=>this.selectedRooms.has(String(roomId))))}}return _exports.default=_default,_exports.default}));

//# sourceMappingURL=resource_catalog.min.js.map