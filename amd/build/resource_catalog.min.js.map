{"version":3,"file":"resource_catalog.min.js","sources":["../src/resource_catalog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Resource catalog reactive component.\n *\n * @module mod_bookit/resource_catalog\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport {resourceReactiveInstance, initResourceReactive} from './resource_reactive';\nimport ResourceCategory from './resource_category';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Resource catalog component.\n */\nexport default class extends BaseComponent {\n    /**\n     * Static init method.\n     *\n     * @param {string} target - CSS selector for container element\n     * @return {ResourceCatalog} Component instance\n     */\n    static init(target) {\n        // Get container element.\n        const element = document.querySelector(target);\n        if (!element) {\n            return null;\n        }\n\n        // Read contextId from DOM.\n        const contextId = parseInt(element.dataset.contextid);\n\n        // Read categories and resources from DOM.\n        const categoriesArray = [];\n        const itemsArray = [];\n\n        const categoryElements = element.querySelectorAll('[data-region=\"resource-category\"]');\n        categoryElements.forEach(categoryEl => {\n            const categoryData = {\n                id: parseInt(categoryEl.dataset.categoryid),\n                name: categoryEl.dataset.categoryName,\n                description: categoryEl.dataset.categoryDescription || '',\n                sortorder: parseInt(categoryEl.dataset.categorySortorder) || 0,\n            };\n            categoriesArray.push(categoryData);\n\n            // Read resources for this category.\n            const itemElements = categoryEl.querySelectorAll('[data-region=\"resource-item\"]');\n            itemElements.forEach(itemEl => {\n                const itemData = {\n                    id: parseInt(itemEl.dataset.itemid),\n                    name: itemEl.dataset.itemName,\n                    description: itemEl.dataset.itemDescription || '',\n                    categoryid: parseInt(itemEl.dataset.itemCategoryid),\n                    amount: parseInt(itemEl.dataset.itemAmount) || 0,\n                    amountirrelevant: itemEl.dataset.itemAmountirrelevant === 'true',\n                    sortorder: parseInt(itemEl.dataset.itemSortorder) || 0,\n                };\n                itemsArray.push(itemData);\n            });\n        });\n\n        // Initialize reactive store.\n        initResourceReactive({\n            categories: categoriesArray,\n            items: itemsArray,\n        });\n\n        return new this({\n            element: element,\n            reactive: resourceReactiveInstance,\n            selectors: {contextId},\n        });\n    }\n\n    /**\n     * Component descriptor for debugging.\n     *\n     * @return {string} Component name\n     */\n    static get componentName() {\n        return 'mod_bookit/resource_catalog';\n    }\n\n    /**\n     * Create component.\n     *\n     * Called by BaseComponent constructor.\n     */\n    create() {\n        this.selectors.categoriesContainer = '#mod-bookit-resource-categories';\n        this.selectors.noCategoriesMsg = '#mod-bookit-no-categories';\n        this.selectors.addCategoryBtn = '#add-category-btn';\n\n        this.categoryComponents = new Map();\n    }\n\n    /**\n     * Initial state ready.\n     *\n     * Called when reactive state is ready.\n     *\n     * @param {Object} state - Reactive state\n     */\n    stateReady(state) {\n        this._initializeExistingComponents(state);\n        this._attachEventListeners();\n    }\n\n    /**\n     * Initialize components for existing DOM elements.\n     *\n     * @param {Object} state - Reactive state\n     */\n    _initializeExistingComponents(state) {\n        const categories = Array.from(state.categories.values());\n\n        categories.forEach(categoryData => {\n            const categoryEl = document.getElementById(`resource-category-${categoryData.id}`);\n            if (categoryEl) {\n                const categoryComponent = new ResourceCategory({\n                    element: categoryEl.parentElement,\n                    reactive: this.reactive,\n                    categoryData: categoryData,\n                    existingElement: categoryEl,\n                });\n                this.categoryComponents.set(categoryData.id, categoryComponent);\n            }\n        });\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        return [\n            {watch: `categories:created`, handler: this._handleCategoryCreated},\n            {watch: `categories:updated`, handler: this._handleCategoryUpdated},\n            {watch: `categories:deleted`, handler: this._handleCategoryDeleted},\n        ];\n    }\n\n    /**\n     * Handle category created.\n     */\n    _handleCategoryCreated() {\n        const state = this.reactive.state;\n        this._renderCategories(state);\n    }\n\n    /**\n     * Render all categories (for dynamic updates).\n     *\n     * @param {Object} state - Reactive state\n     */\n    _renderCategories(state) {\n        const container = document.querySelector(this.selectors.categoriesContainer);\n        if (!container) {\n            return;\n        }\n\n        const categories = Array.from(state.categories.values())\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Clear existing.\n        container.innerHTML = '';\n        this.categoryComponents.clear();\n\n        if (categories.length === 0) {\n            this._showNoCategoriesMessage();\n            return;\n        }\n\n        this._hideNoCategoriesMessage();\n\n        // Render each category.\n        categories.forEach(categoryData => {\n            const categoryComponent = new ResourceCategory({\n                element: container,\n                reactive: this.reactive,\n                categoryData: categoryData,\n            });\n            this.categoryComponents.set(categoryData.id, categoryComponent);\n        });\n    }\n\n    /**\n     * Handle category updated.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated category data\n     */\n    _handleCategoryUpdated({element}) {\n        const component = this.categoryComponents.get(element.id);\n        if (component) {\n            component.update(element);\n        }\n    }\n\n    /**\n     * Handle category deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted category data\n     */\n    _handleCategoryDeleted({element}) {\n        const component = this.categoryComponents.get(element.id);\n        if (component) {\n            component.remove();\n            this.categoryComponents.delete(element.id);\n        }\n\n        const state = this.reactive.state;\n        if (state.categories.size === 0) {\n            this._showNoCategoriesMessage();\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        const addBtn = document.querySelector(this.selectors.addCategoryBtn);\n        if (addBtn) {\n            addBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this._handleAddCategory();\n            });\n        }\n    }\n\n    /**\n     * Handle add category action.\n     */\n    async _handleAddCategory() {\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\form\\\\edit_resource_category_form',\n            args: {\n                contextid: this.selectors.contextId,\n            },\n            modalConfig: {\n                title: await getString('resources:add_category', 'mod_bookit'),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.dispatch('createCategory', e.detail);\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Show no categories message.\n     */\n    _showNoCategoriesMessage() {\n        const msg = document.querySelector(this.selectors.noCategoriesMsg);\n        if (msg) {\n            msg.classList.remove('d-none');\n        }\n    }\n\n    /**\n     * Hide no categories message.\n     */\n    _hideNoCategoriesMessage() {\n        const msg = document.querySelector(this.selectors.noCategoriesMsg);\n        if (msg) {\n            msg.classList.add('d-none');\n        }\n    }\n}\n"],"names":["BaseComponent","target","element","document","querySelector","contextId","parseInt","dataset","contextid","categoriesArray","itemsArray","querySelectorAll","forEach","categoryEl","categoryData","id","categoryid","name","categoryName","description","categoryDescription","sortorder","categorySortorder","push","itemEl","itemData","itemid","itemName","itemDescription","itemCategoryid","amount","itemAmount","amountirrelevant","itemAmountirrelevant","itemSortorder","categories","items","this","reactive","resourceReactiveInstance","selectors","componentName","create","categoriesContainer","noCategoriesMsg","addCategoryBtn","categoryComponents","Map","stateReady","state","_initializeExistingComponents","_attachEventListeners","Array","from","values","getElementById","categoryComponent","ResourceCategory","parentElement","existingElement","set","getWatchers","watch","handler","_handleCategoryCreated","_handleCategoryUpdated","_handleCategoryDeleted","_renderCategories","container","sort","a","b","innerHTML","clear","length","_hideNoCategoriesMessage","_showNoCategoriesMessage","component","get","update","remove","delete","size","addBtn","addEventListener","e","preventDefault","_handleAddCategory","modalForm","ModalForm","formClass","args","modalConfig","title","events","FORM_SUBMITTED","dispatch","detail","show","msg","classList","add"],"mappings":"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"}