{"version":3,"file":"resource_catalog.min.js","sources":["../src/resource_catalog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Resource catalog reactive component.\n *\n * @module mod_bookit/resource_catalog\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport {resourceReactiveInstance, initResourceReactive} from './resource_reactive';\nimport ResourceCategory from './resource_category';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Initialize resource catalog.\n *\n * @param {number} contextId - System context ID\n * @param {string} categoriesJson - JSON string with categories data\n */\nexport const init = (contextId, categoriesJson) => {\n    const categories = JSON.parse(categoriesJson);\n\n    // Prepare state data.\n    const categoriesMap = new Map();\n    const itemsMap = new Map();\n\n    categories.forEach(category => {\n        categoriesMap.set(category.id, {\n            id: category.id,\n            name: category.name,\n            description: category.description,\n            sortorder: category.sortorder,\n        });\n\n        if (category.resources && Array.isArray(category.resources)) {\n            category.resources.forEach(resource => {\n                itemsMap.set(resource.id, {\n                    id: resource.id,\n                    name: resource.name,\n                    description: resource.description,\n                    categoryid: category.id,\n                    amount: resource.amount,\n                    amountirrelevant: resource.amountirrelevant,\n                    sortorder: resource.sortorder,\n                });\n            });\n        }\n    });\n\n    // Initialize reactive store.\n    initResourceReactive({\n        categories: categoriesMap,\n        items: itemsMap,\n    });\n\n    // Initialize catalog component.\n    ResourceCatalog.init('#mod-bookit-resource-catalog', {contextId});\n};\n\n/**\n * Resource catalog component.\n */\nclass ResourceCatalog extends BaseComponent {\n    /**\n     * Static init method.\n     *\n     * @param {string} target - CSS selector for container element\n     * @param {Object} selectors - Additional configuration\n     * @param {number} selectors.contextId - System context ID\n     * @return {ResourceCatalog} Component instance\n     */\n    static init(target, selectors) {\n        return new this({\n            element: document.querySelector(target),\n            reactive: resourceReactiveInstance,\n            selectors,\n        });\n    }\n\n    /**\n     * Component descriptor for debugging.\n     *\n     * @return {string} Component name\n     */\n    static get componentName() {\n        return 'mod_bookit/resource_catalog';\n    }\n\n    /**\n     * Create component.\n     *\n     * Called by BaseComponent constructor.\n     */\n    create() {\n        this.selectors.categoriesContainer = '#mod-bookit-resource-categories';\n        this.selectors.spinner = '#mod-bookit-resource-spinner';\n        this.selectors.content = '#mod-bookit-resource-content';\n        this.selectors.noCategoriesMsg = '#mod-bookit-no-categories';\n        this.selectors.addCategoryBtn = '#add-category-btn';\n\n        this.categoryComponents = new Map();\n    }\n\n    /**\n     * Initial state ready.\n     *\n     * Called when reactive state is ready.\n     *\n     * @param {Object} state - Reactive state\n     */\n    stateReady(state) {\n        this._renderCategories(state);\n        this._attachEventListeners();\n        this._hideSpinner();\n        this._showContent();\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        return [\n            {watch: `categories:created`, handler: this._handleCategoryCreated},\n            {watch: `categories:updated`, handler: this._handleCategoryUpdated},\n            {watch: `categories:deleted`, handler: this._handleCategoryDeleted},\n        ];\n    }\n\n    /**\n     * Render all categories.\n     *\n     * @param {Object} state - Reactive state\n     */\n    _renderCategories(state) {\n        const container = document.querySelector(this.selectors.categoriesContainer);\n        if (!container) {\n            return;\n        }\n\n        const categories = Array.from(state.categories.values())\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Clear existing.\n        container.innerHTML = '';\n        this.categoryComponents.clear();\n\n        if (categories.length === 0) {\n            this._showNoCategoriesMessage();\n            return;\n        }\n\n        this._hideNoCategoriesMessage();\n\n        // Render each category.\n        categories.forEach(categoryData => {\n            const categoryComponent = new ResourceCategory({\n                element: container,\n                reactive: this.reactive,\n                categoryData: categoryData,\n            });\n            this.categoryComponents.set(categoryData.id, categoryComponent);\n        });\n    }\n\n    /**\n     * Handle category created.\n     */\n    _handleCategoryCreated() {\n        const state = this.reactive.state;\n        this._renderCategories(state);\n    }\n\n    /**\n     * Handle category updated.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated category data\n     */\n    _handleCategoryUpdated({element}) {\n        const component = this.categoryComponents.get(element.id);\n        if (component) {\n            component.update(element);\n        }\n    }\n\n    /**\n     * Handle category deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted category data\n     */\n    _handleCategoryDeleted({element}) {\n        const component = this.categoryComponents.get(element.id);\n        if (component) {\n            component.remove();\n            this.categoryComponents.delete(element.id);\n        }\n\n        const state = this.reactive.state;\n        if (state.categories.size === 0) {\n            this._showNoCategoriesMessage();\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        const addBtn = document.querySelector(this.selectors.addCategoryBtn);\n        if (addBtn) {\n            addBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this._handleAddCategory();\n            });\n        }\n    }\n\n    /**\n     * Handle add category action.\n     */\n    async _handleAddCategory() {\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\form\\\\resource_category_form',\n            args: {\n                contextid: this.selectors.contextId,\n            },\n            modalConfig: {\n                title: await getString('resources:add_category', 'mod_bookit'),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.dispatch('createCategory', e.detail);\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Hide spinner.\n     */\n    _hideSpinner() {\n        const spinner = document.querySelector(this.selectors.spinner);\n        if (spinner) {\n            spinner.classList.add('d-none');\n        }\n    }\n\n    /**\n     * Show content.\n     */\n    _showContent() {\n        const content = document.querySelector(this.selectors.content);\n        if (content) {\n            content.classList.remove('d-none');\n        }\n    }\n\n    /**\n     * Show no categories message.\n     */\n    _showNoCategoriesMessage() {\n        const msg = document.querySelector(this.selectors.noCategoriesMsg);\n        if (msg) {\n            msg.classList.remove('d-none');\n        }\n    }\n\n    /**\n     * Hide no categories message.\n     */\n    _hideNoCategoriesMessage() {\n        const msg = document.querySelector(this.selectors.noCategoriesMsg);\n        if (msg) {\n            msg.classList.add('d-none');\n        }\n    }\n}\n\nexport default ResourceCatalog;\n"],"names":["contextId","categoriesJson","categories","JSON","parse","categoriesMap","Map","itemsMap","forEach","category","set","id","name","description","sortorder","resources","Array","isArray","resource","categoryid","amount","amountirrelevant","items","ResourceCatalog","init","BaseComponent","target","selectors","this","element","document","querySelector","reactive","resourceReactiveInstance","componentName","create","categoriesContainer","spinner","content","noCategoriesMsg","addCategoryBtn","categoryComponents","stateReady","state","_renderCategories","_attachEventListeners","_hideSpinner","_showContent","getWatchers","watch","handler","_handleCategoryCreated","_handleCategoryUpdated","_handleCategoryDeleted","container","from","values","sort","a","b","innerHTML","clear","length","_hideNoCategoriesMessage","categoryData","categoryComponent","ResourceCategory","_showNoCategoriesMessage","component","get","update","remove","delete","size","addBtn","addEventListener","e","preventDefault","_handleAddCategory","modalForm","ModalForm","formClass","args","contextid","modalConfig","title","events","FORM_SUBMITTED","dispatch","detail","show","classList","add","msg"],"mappings":"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"}