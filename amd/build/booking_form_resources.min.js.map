{"version":3,"file":"booking_form_resources.min.js","sources":["../src/booking_form_resources.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Room-based resource filtering for booking form.\n *\n * This module handles filtering of resources based on room selection in the booking form.\n * It disables resources that are not available in the selected room and validates that\n * all selected resources are available in the chosen room.\n *\n * @module     mod_bookit/booking_form_resources\n * @copyright  2026 ssystems GmbH <oss@ssystems.de>\n * @author     Andreas Rosenthal\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/log', 'core/str', 'core/notification'],\nfunction($, Log, Str, Notification) {\n\n    /**\n     * Selectors for DOM elements.\n     *\n     * @type {Object}\n     */\n    const SELECTORS = {\n        ROOM_SELECT: 'select[name=\"roomid\"]',\n        RESOURCE_CHECKBOX: '[name^=\"resource_selected_\"]',\n        RESOURCE_GROUP: '[id^=\"resourcegroup_\"]',\n        RESOURCE_AMOUNT: '[name^=\"resource_amount_\"]',\n        CATEGORY_HEADER: '[id^=\"header_cat_\"]',\n    };\n\n    /**\n     * CSS classes for styling.\n     *\n     * @type {Object}\n     */\n    const CSS = {\n        DISABLED: 'disabled',\n        UNAVAILABLE: 'text-muted',\n        CONFLICT: 'alert-danger',\n    };\n\n    /**\n     * Module state.\n     *\n     * @type {Object}\n     */\n    let state = {\n        roomResourceMap: {},\n        resourceRooms: {},\n        currentRoom: null,\n        selectedResources: [],\n    };\n\n    /**\n     * Filter resources based on selected room.\n     *\n     * If no room is selected, all resources are enabled.\n     * If a room is selected, only resources available in that room are enabled.\n     *\n     * @param {Number} roomId The selected room ID\n     */\n    const filterResourcesByRoom = function(roomId) {\n        if (!roomId) {\n            // No room selected - enable all resources.\n            enableAllResources();\n            return;\n        }\n\n        const availableResources = state.roomResourceMap[roomId] || [];\n\n        $(SELECTORS.RESOURCE_CHECKBOX).each(function() {\n            const checkbox = $(this);\n            const resourceId = getResourceIdFromElement(checkbox);\n\n            if (availableResources.includes(resourceId)) {\n                // Resource available in this room.\n                enableResource(checkbox);\n            } else {\n                // Resource NOT available in this room.\n                disableResource(checkbox);\n            }\n        });\n    };\n\n    /**\n     * Enable a resource checkbox.\n     *\n     * Removes disabled state and unavailable styling.\n     *\n     * @param {jQuery} checkbox The checkbox element\n     */\n    const enableResource = function(checkbox) {\n        checkbox.prop('disabled', false);\n        checkbox.closest(SELECTORS.RESOURCE_GROUP)\n            .removeClass(CSS.UNAVAILABLE)\n            .removeClass(CSS.CONFLICT);\n    };\n\n    /**\n     * Disable a resource checkbox.\n     *\n     * Sets disabled state and adds unavailable styling.\n     * Does not uncheck if already checked (preserves selection for conflict detection).\n     *\n     * @param {jQuery} checkbox The checkbox element\n     */\n    const disableResource = function(checkbox) {\n        checkbox.prop('disabled', true);\n        checkbox.closest(SELECTORS.RESOURCE_GROUP)\n            .addClass(CSS.UNAVAILABLE);\n    };\n\n    /**\n     * Enable all resources (when no room selected).\n     */\n    const enableAllResources = function() {\n        $(SELECTORS.RESOURCE_CHECKBOX).each(function() {\n            enableResource($(this));\n        });\n    };\n\n    /**\n     * Extract resource ID from form element name.\n     *\n     * Parses the element name attribute to extract the resource ID.\n     * Expected format: resource_selected_123\n     *\n     * @param {jQuery} element The form element\n     * @return {Number|null} The resource ID or null if not found\n     */\n    const getResourceIdFromElement = function(element) {\n        const name = element.attr('name');\n        const match = name.match(/resource_selected_(\\d+)/);\n        return match ? parseInt(match[1], 10) : null;\n    };\n\n    /**\n     * Check for resource-room conflicts.\n     *\n     * Validates that all selected resources are available in the selected room.\n     * If conflicts exist, shows an error notification and highlights conflicting resources.\n     *\n     * @return {Boolean} True if conflicts exist\n     */\n    const checkForConflicts = function() {\n        const roomId = parseInt($(SELECTORS.ROOM_SELECT).val(), 10);\n        if (!roomId) {\n            return false;\n        }\n\n        const selectedResourceIds = getSelectedResourceIds();\n        const availableResources = state.roomResourceMap[roomId] || [];\n\n        const conflicts = selectedResourceIds.filter(id => !availableResources.includes(id));\n\n        if (conflicts.length > 0) {\n            showConflictError(conflicts);\n            return true;\n        }\n\n        return false;\n    };\n\n    /**\n     * Get IDs of all selected resources.\n     *\n     * @return {Array} Array of resource IDs\n     */\n    const getSelectedResourceIds = function() {\n        const selected = [];\n        $(SELECTORS.RESOURCE_CHECKBOX + ':checked').each(function() {\n            const resourceId = getResourceIdFromElement($(this));\n            if (resourceId) {\n                selected.push(resourceId);\n            }\n        });\n        return selected;\n    };\n\n    /**\n     * Show conflict error notification.\n     *\n     * Displays a Moodle error notification and highlights conflicting resources.\n     *\n     * @param {Array} conflictingIds Array of conflicting resource IDs\n     */\n    const showConflictError = function(conflictingIds) {\n        Str.get_string('booking:resource_room_conflict', 'mod_bookit').then(function(message) {\n            Notification.addNotification({\n                message: message,\n                type: 'error',\n            });\n\n            // Highlight conflicting resources.\n            conflictingIds.forEach(function(id) {\n                $('[name=\"resource_selected_' + id + '\"]')\n                    .closest(SELECTORS.RESOURCE_GROUP)\n                    .addClass(CSS.CONFLICT);\n            });\n\n            return true;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Register event listeners.\n     *\n     * Sets up event listeners for room selection and resource checkbox changes.\n     * Uses event delegation for better performance and compatibility with dynamic content.\n     */\n    const registerEventListeners = function() {\n        // Listen to room selection changes.\n        $(document).on('change', SELECTORS.ROOM_SELECT, function() {\n            const roomId = parseInt($(this).val(), 10);\n            state.currentRoom = roomId;\n            filterResourcesByRoom(roomId);\n            checkForConflicts();\n        });\n\n        // Listen to resource checkbox changes.\n        $(document).on('change', SELECTORS.RESOURCE_CHECKBOX, function() {\n            // Clear conflict styling.\n            $(this).closest(SELECTORS.RESOURCE_GROUP).removeClass(CSS.CONFLICT);\n\n            // Check for new conflicts.\n            if (state.currentRoom) {\n                checkForConflicts();\n            }\n        });\n    };\n\n    /**\n     * Initialize the module.\n     *\n     * Sets up the module with room-resource mapping data and registers event listeners.\n     *\n     * @param {Object} roomResourceMapData Mapping of room IDs to resource IDs\n     * @param {Object} resourceRoomsData Mapping of resource IDs to room details\n     */\n    const init = function(roomResourceMapData, resourceRoomsData) {\n        state.roomResourceMap = roomResourceMapData;\n        state.resourceRooms = resourceRoomsData;\n\n        // Get current room if already selected.\n        const currentRoomId = parseInt($(SELECTORS.ROOM_SELECT).val(), 10);\n        if (currentRoomId) {\n            state.currentRoom = currentRoomId;\n            filterResourcesByRoom(currentRoomId);\n        }\n\n        // Register event listeners.\n        registerEventListeners();\n\n        Log.debug('mod_bookit/booking_form_resources: Initialized with room map', state.roomResourceMap);\n    };\n\n    // Public API.\n    return {\n        init: init,\n    };\n});\n"],"names":["define","$","Log","Str","Notification","SELECTORS","CSS","state","roomResourceMap","resourceRooms","currentRoom","selectedResources","filterResourcesByRoom","roomId","enableAllResources","availableResources","each","checkbox","this","resourceId","getResourceIdFromElement","includes","enableResource","disableResource","prop","closest","removeClass","addClass","element","match","attr","parseInt","checkForConflicts","val","selectedResourceIds","getSelectedResourceIds","conflicts","filter","id","length","showConflictError","selected","push","conflictingIds","get_string","then","message","addNotification","type","forEach","catch","exception","init","roomResourceMapData","resourceRoomsData","currentRoomId","document","on","debug"],"mappings":";;;;;;;;;;;;AA2BAA,2CAAO,CAAC,SAAU,WAAY,WAAY,sBAC1C,SAASC,EAAGC,IAAKC,IAAKC,oBAOZC,sBACW,wBADXA,4BAEiB,+BAFjBA,yBAGc,yBAUdC,gBAEW,aAFXA,aAGQ,mBAQVC,MAAQ,CACRC,gBAAiB,GACjBC,cAAe,GACfC,YAAa,KACbC,kBAAmB,UAWjBC,sBAAwB,SAASC,YAC9BA,mBAEDC,2BAIEC,mBAAqBR,MAAMC,gBAAgBK,SAAW,GAE5DZ,EAAEI,6BAA6BW,MAAK,iBAC1BC,SAAWhB,EAAEiB,MACbC,WAAaC,yBAAyBH,UAExCF,mBAAmBM,SAASF,YAE5BG,eAAeL,UAGfM,gBAAgBN,cAYtBK,eAAiB,SAASL,UAC5BA,SAASO,KAAK,YAAY,GAC1BP,SAASQ,QAAQpB,0BACZqB,YAAYpB,iBACZoB,YAAYpB,eAWfiB,gBAAkB,SAASN,UAC7BA,SAASO,KAAK,YAAY,GAC1BP,SAASQ,QAAQpB,0BACZsB,SAASrB,kBAMZQ,mBAAqB,WACvBb,EAAEI,6BAA6BW,MAAK,WAChCM,eAAerB,EAAEiB,WAanBE,yBAA2B,SAASQ,eAEhCC,MADOD,QAAQE,KAAK,QACPD,MAAM,kCAClBA,MAAQE,SAASF,MAAM,GAAI,IAAM,MAWtCG,kBAAoB,iBAChBnB,OAASkB,SAAS9B,EAAEI,uBAAuB4B,MAAO,QACnDpB,cACM,QAGLqB,oBAAsBC,yBACtBpB,mBAAqBR,MAAMC,gBAAgBK,SAAW,GAEtDuB,UAAYF,oBAAoBG,QAAOC,KAAOvB,mBAAmBM,SAASiB,aAE5EF,UAAUG,OAAS,IACnBC,kBAAkBJ,YACX,IAWTD,uBAAyB,iBACrBM,SAAW,UACjBxC,EAAEI,4BAA8B,YAAYW,MAAK,iBACvCG,WAAaC,yBAAyBnB,EAAEiB,OAC1CC,YACAsB,SAASC,KAAKvB,eAGfsB,UAULD,kBAAoB,SAASG,gBAC/BxC,IAAIyC,WAAW,iCAAkC,cAAcC,MAAK,SAASC,gBACzE1C,aAAa2C,gBAAgB,CACzBD,QAASA,QACTE,KAAM,UAIVL,eAAeM,SAAQ,SAASX,IAC5BrC,EAAE,4BAA8BqC,GAAK,MAChCb,QAAQpB,0BACRsB,SAASrB,kBAGX,KACR4C,MAAM9C,aAAa+C,kBAwDnB,CACHC,KAnBS,SAASC,oBAAqBC,mBACvC/C,MAAMC,gBAAkB6C,oBACxB9C,MAAME,cAAgB6C,wBAGhBC,cAAgBxB,SAAS9B,EAAEI,uBAAuB4B,MAAO,IAC3DsB,gBACAhD,MAAMG,YAAc6C,cACpB3C,sBAAsB2C,gBAnC1BtD,EAAEuD,UAAUC,GAAG,SAAUpD,uBAAuB,iBACtCQ,OAASkB,SAAS9B,EAAEiB,MAAMe,MAAO,IACvC1B,MAAMG,YAAcG,OACpBD,sBAAsBC,QACtBmB,uBAIJ/B,EAAEuD,UAAUC,GAAG,SAAUpD,6BAA6B,WAElDJ,EAAEiB,MAAMO,QAAQpB,0BAA0BqB,YAAYpB,cAGlDC,MAAMG,aACNsB,uBA2BR9B,IAAIwD,MAAM,+DAAgEnD,MAAMC"}