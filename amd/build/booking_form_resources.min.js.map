{"version":3,"file":"booking_form_resources.min.js","sources":["../src/booking_form_resources.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Room-based resource filtering for booking form.\n *\n * This module handles filtering of resources based on room selection in the booking form.\n * It disables resources that are not available in the selected room and validates that\n * all selected resources are available in the chosen room.\n *\n * @module     mod_bookit/booking_form_resources\n * @copyright  2026 ssystems GmbH <oss@ssystems.de>\n * @author     Andreas Rosenthal\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/log', 'core/str', 'core/notification'],\nfunction($, Log, Str, Notification) {\n\n    /**\n     * Selectors for DOM elements.\n     *\n     * @type {Object}\n     */\n    const SELECTORS = {\n        ROOM_SELECT: 'select[name=\"roomid\"]',\n        RESOURCE_CHECKBOX: '[name^=\"resource_selected_\"]',\n        RESOURCE_GROUP: '[id^=\"resourcegroup_\"]',\n        RESOURCE_AMOUNT: '[name^=\"resource_amount_\"]',\n        CATEGORY_HEADER: '[id^=\"header_cat_\"]',\n    };\n\n    /**\n     * CSS classes for styling.\n     *\n     * @type {Object}\n     */\n    const CSS = {\n        DISABLED: 'disabled',\n        UNAVAILABLE: 'text-muted',\n        CONFLICT: 'alert-danger',\n    };\n\n    /**\n     * Module state.\n     *\n     * @type {Object}\n     */\n    let state = {\n        roomResourceMap: {},\n        resourceRooms: {},\n        currentRoom: null,\n        selectedResources: [],\n    };\n\n    /**\n     * Filter resources based on selected room.\n     *\n     * Resources with NO room assignments are always hidden (cannot be booked).\n     * If no room is selected, show only resources that have room assignments.\n     * If a room is selected, show only resources available in that room.\n     *\n     * @param {Number} roomId The selected room ID (null if no room selected)\n     */\n    const filterResourcesByRoom = function(roomId) {\n        // Defensive check: ensure data is loaded.\n        if (!state.roomResourceMap) {\n            Log.debug('[BookIt Resources] roomResourceMap not yet loaded, skipping filter');\n            return;\n        }\n\n        // Get all resources that have at least one room assignment.\n        const bookableResourceIds = state.resourceRooms ? Object.keys(state.resourceRooms).map(id => parseInt(id, 10)) : [];\n\n        if (!roomId) {\n            // No room selected - show only resources that have room assignments.\n            $(SELECTORS.RESOURCE_CHECKBOX).each(function() {\n                const checkbox = $(this);\n                const resourceId = getResourceIdFromElement(checkbox);\n\n                if (bookableResourceIds.includes(resourceId)) {\n                    enableResource(checkbox);\n                } else {\n                    // Resource has no room assignments - hide it.\n                    disableResource(checkbox);\n                }\n            });\n            return;\n        }\n\n        // Room selected - show only resources available in that specific room.\n        const availableResources = state.roomResourceMap[roomId] || [];\n\n        $(SELECTORS.RESOURCE_CHECKBOX).each(function() {\n            const checkbox = $(this);\n            const resourceId = getResourceIdFromElement(checkbox);\n\n            if (availableResources.includes(resourceId)) {\n                // Resource available in this room.\n                enableResource(checkbox);\n            } else {\n                // Resource NOT available in this room (or has no room assignments at all).\n                disableResource(checkbox);\n            }\n        });\n    };\n\n    /**\n     * Enable a resource checkbox.\n     *\n     * Removes disabled state, shows the resource row, and removes conflict styling.\n     *\n     * @param {jQuery} checkbox The checkbox element\n     */\n    const enableResource = function(checkbox) {\n        checkbox.prop('disabled', false);\n        checkbox.closest(SELECTORS.RESOURCE_GROUP)\n            .show()\n            .removeClass(CSS.CONFLICT);\n    };\n\n    /**\n     * Disable a resource checkbox.\n     *\n     * Sets disabled state and HIDES the entire resource row.\n     * Does not uncheck if already checked (preserves selection for conflict detection).\n     *\n     * @param {jQuery} checkbox The checkbox element\n     */\n    const disableResource = function(checkbox) {\n        checkbox.prop('disabled', true);\n        checkbox.closest(SELECTORS.RESOURCE_GROUP).hide();\n    };\n\n    /**\n     * Extract resource ID from form element name.\n     *\n     * Parses the element name attribute to extract the resource ID.\n     * Expected format: resource_selected_123\n     *\n     * @param {jQuery} element The form element\n     * @return {Number|null} The resource ID or null if not found\n     */\n    const getResourceIdFromElement = function(element) {\n        const name = element.attr('name');\n        const match = name.match(/resource_selected_(\\d+)/);\n        return match ? parseInt(match[1], 10) : null;\n    };\n\n    /**\n     * Check for resource-room conflicts.\n     *\n     * Validates that all selected resources are available in the selected room.\n     * If conflicts exist, shows an error notification and highlights conflicting resources.\n     *\n     * @return {Boolean} True if conflicts exist\n     */\n    const checkForConflicts = function() {\n        const roomId = parseInt($(SELECTORS.ROOM_SELECT).val(), 10);\n        if (!roomId) {\n            return false;\n        }\n\n        const selectedResourceIds = getSelectedResourceIds();\n        const availableResources = state.roomResourceMap[roomId] || [];\n\n        const conflicts = selectedResourceIds.filter(id => !availableResources.includes(id));\n\n        if (conflicts.length > 0) {\n            showConflictError(conflicts);\n            return true;\n        }\n\n        return false;\n    };\n\n    /**\n     * Get IDs of all selected resources.\n     *\n     * @return {Array} Array of resource IDs\n     */\n    const getSelectedResourceIds = function() {\n        const selected = [];\n        $(SELECTORS.RESOURCE_CHECKBOX + ':checked').each(function() {\n            const resourceId = getResourceIdFromElement($(this));\n            if (resourceId) {\n                selected.push(resourceId);\n            }\n        });\n        return selected;\n    };\n\n    /**\n     * Show conflict error notification.\n     *\n     * Displays a Moodle error notification and highlights conflicting resources.\n     *\n     * @param {Array} conflictingIds Array of conflicting resource IDs\n     */\n    const showConflictError = function(conflictingIds) {\n        Str.get_string('booking:resource_room_conflict', 'mod_bookit').then(function(message) {\n            Notification.addNotification({\n                message: message,\n                type: 'error',\n            });\n\n            // Highlight conflicting resources.\n            conflictingIds.forEach(function(id) {\n                $('[name=\"resource_selected_' + id + '\"]')\n                    .closest(SELECTORS.RESOURCE_GROUP)\n                    .addClass(CSS.CONFLICT);\n            });\n\n            return true;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Register event listeners.\n     *\n     * Sets up event listeners for room selection and resource checkbox changes.\n     * Uses event delegation for better performance and compatibility with dynamic content.\n     */\n    const registerEventListeners = function() {\n        // Listen to room selection changes.\n        $(document).on('change', SELECTORS.ROOM_SELECT, function() {\n            const roomId = parseInt($(this).val(), 10);\n            state.currentRoom = roomId;\n            filterResourcesByRoom(roomId);\n            checkForConflicts();\n        });\n\n        // Listen to resource checkbox changes.\n        $(document).on('change', SELECTORS.RESOURCE_CHECKBOX, function() {\n            // Clear conflict styling.\n            $(this).closest(SELECTORS.RESOURCE_GROUP).removeClass(CSS.CONFLICT);\n\n            // Check for new conflicts.\n            if (state.currentRoom) {\n                checkForConflicts();\n            }\n        });\n    };\n\n    /**\n     * Initialize the module.\n     *\n     * Sets up the module with room-resource mapping data and registers event listeners.\n     *\n     * @param {Object} roomResourceMapData Mapping of room IDs to resource IDs\n     * @param {Object} resourceRoomsData Mapping of resource IDs to room details\n     */\n    const init = function(roomResourceMapData, resourceRoomsData) {\n        Log.debug('[BookIt Resources] Initializing booking form resources filter');\n        Log.debug('[BookIt Resources] roomResourceMap:', roomResourceMapData);\n        Log.debug('[BookIt Resources] resourceRooms:', resourceRoomsData);\n\n        state.roomResourceMap = roomResourceMapData;\n        state.resourceRooms = resourceRoomsData;\n\n        // Wait for form to be ready (modal may not be loaded yet).\n        const initWhenReady = function() {\n            const roomSelect = $(SELECTORS.ROOM_SELECT);\n            if (roomSelect.length === 0) {\n                Log.debug('[BookIt Resources] Room select not found yet, waiting...');\n                setTimeout(initWhenReady, 100);\n                return;\n            }\n\n            Log.debug('[BookIt Resources] Room select found, setting up event handlers');\n\n            // Get current room if already selected.\n            const currentRoomId = parseInt(roomSelect.val(), 10);\n            if (currentRoomId) {\n                state.currentRoom = currentRoomId;\n                filterResourcesByRoom(currentRoomId);\n            }\n\n            // Register event listeners.\n            registerEventListeners();\n\n            Log.debug('[BookIt Resources] Initialization complete');\n        };\n\n        // Start initialization check.\n        initWhenReady();\n    };\n\n    // Public API.\n    return {\n        init: init,\n    };\n});\n"],"names":["define","$","Log","Str","Notification","SELECTORS","CSS","state","roomResourceMap","resourceRooms","currentRoom","selectedResources","filterResourcesByRoom","roomId","debug","bookableResourceIds","Object","keys","map","id","parseInt","each","checkbox","this","resourceId","getResourceIdFromElement","includes","enableResource","disableResource","availableResources","prop","closest","show","removeClass","hide","element","match","attr","checkForConflicts","val","selectedResourceIds","getSelectedResourceIds","conflicts","filter","length","showConflictError","selected","push","conflictingIds","get_string","then","message","addNotification","type","forEach","addClass","catch","exception","init","roomResourceMapData","resourceRoomsData","initWhenReady","roomSelect","setTimeout","currentRoomId","document","on"],"mappings":";;;;;;;;;;;;AA2BAA,2CAAO,CAAC,SAAU,WAAY,WAAY,sBAC1C,SAASC,EAAGC,IAAKC,IAAKC,oBAOZC,sBACW,wBADXA,4BAEiB,+BAFjBA,yBAGc,yBAUdC,aAGQ,mBAQVC,MAAQ,CACRC,gBAAiB,GACjBC,cAAe,GACfC,YAAa,KACbC,kBAAmB,UAYjBC,sBAAwB,SAASC,YAE9BN,MAAMC,4BACPN,IAAIY,MAAM,4EAKRC,oBAAsBR,MAAME,cAAgBO,OAAOC,KAAKV,MAAME,eAAeS,KAAIC,IAAMC,SAASD,GAAI,MAAO,OAE5GN,mBAEDZ,EAAEI,6BAA6BgB,MAAK,iBAC1BC,SAAWrB,EAAEsB,MACbC,WAAaC,yBAAyBH,UAExCP,oBAAoBW,SAASF,YAC7BG,eAAeL,UAGfM,gBAAgBN,mBAOtBO,mBAAqBtB,MAAMC,gBAAgBK,SAAW,GAE5DZ,EAAEI,6BAA6BgB,MAAK,iBAC1BC,SAAWrB,EAAEsB,MACbC,WAAaC,yBAAyBH,UAExCO,mBAAmBH,SAASF,YAE5BG,eAAeL,UAGfM,gBAAgBN,cAYtBK,eAAiB,SAASL,UAC5BA,SAASQ,KAAK,YAAY,GAC1BR,SAASS,QAAQ1B,0BACZ2B,OACAC,YAAY3B,eAWfsB,gBAAkB,SAASN,UAC7BA,SAASQ,KAAK,YAAY,GAC1BR,SAASS,QAAQ1B,0BAA0B6B,QAYzCT,yBAA2B,SAASU,eAEhCC,MADOD,QAAQE,KAAK,QACPD,MAAM,kCAClBA,MAAQhB,SAASgB,MAAM,GAAI,IAAM,MAWtCE,kBAAoB,iBAChBzB,OAASO,SAASnB,EAAEI,uBAAuBkC,MAAO,QACnD1B,cACM,QAGL2B,oBAAsBC,yBACtBZ,mBAAqBtB,MAAMC,gBAAgBK,SAAW,GAEtD6B,UAAYF,oBAAoBG,QAAOxB,KAAOU,mBAAmBH,SAASP,aAE5EuB,UAAUE,OAAS,IACnBC,kBAAkBH,YACX,IAWTD,uBAAyB,iBACrBK,SAAW,UACjB7C,EAAEI,4BAA8B,YAAYgB,MAAK,iBACvCG,WAAaC,yBAAyBxB,EAAEsB,OAC1CC,YACAsB,SAASC,KAAKvB,eAGfsB,UAULD,kBAAoB,SAASG,gBAC/B7C,IAAI8C,WAAW,iCAAkC,cAAcC,MAAK,SAASC,gBACzE/C,aAAagD,gBAAgB,CACzBD,QAASA,QACTE,KAAM,UAIVL,eAAeM,SAAQ,SAASnC,IAC5BlB,EAAE,4BAA8BkB,GAAK,MAChCY,QAAQ1B,0BACRkD,SAASjD,kBAGX,KACRkD,MAAMpD,aAAaqD,kBA2EnB,CACHC,KAtCS,SAASC,oBAAqBC,mBACvC1D,IAAIY,MAAM,iEACVZ,IAAIY,MAAM,sCAAuC6C,qBACjDzD,IAAIY,MAAM,oCAAqC8C,mBAE/CrD,MAAMC,gBAAkBmD,oBACxBpD,MAAME,cAAgBmD,wBAGhBC,cAAgB,iBACZC,WAAa7D,EAAEI,0BACK,IAAtByD,WAAWlB,cACX1C,IAAIY,MAAM,iEACViD,WAAWF,cAAe,KAI9B3D,IAAIY,MAAM,yEAGJkD,cAAgB5C,SAAS0C,WAAWvB,MAAO,IAC7CyB,gBACAzD,MAAMG,YAAcsD,cACpBpD,sBAAsBoD,gBAlD9B/D,EAAEgE,UAAUC,GAAG,SAAU7D,uBAAuB,iBACtCQ,OAASO,SAASnB,EAAEsB,MAAMgB,MAAO,IACvChC,MAAMG,YAAcG,OACpBD,sBAAsBC,QACtByB,uBAIJrC,EAAEgE,UAAUC,GAAG,SAAU7D,6BAA6B,WAElDJ,EAAEsB,MAAMQ,QAAQ1B,0BAA0B4B,YAAY3B,cAGlDC,MAAMG,aACN4B,uBA0CJpC,IAAIY,MAAM,+CAId+C"}