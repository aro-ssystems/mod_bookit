{"version":3,"file":"master_checklist_mutations.min.js","sources":["../../src/masterchecklist/master_checklist_mutations.js"],"sourcesContent":["import Ajax from 'core/ajax';\n\nexport default class {\n    masterChecklistStateEvent() {\n        // This method is intentionally empty - it's a placeholder for state events.\n    }\n\n    _callDynamicForm(stateManager, data, processUpdates = true) {\n        const type = data.formType;\n        data.formData[`_qf__mod_bookit_local_form_masterchecklist_edit_checklist_${type}_form`] = 1;\n        const formData = new URLSearchParams(data.formData).toString();\n\n        Ajax.call([{\n            methodname: 'core_form_dynamic_form',\n            args: {\n                formdata: formData,\n                form: `mod_bookit\\\\local\\\\form\\\\masterchecklist\\\\edit_checklist_${type}_form`\n            }\n        }])[0]\n        .then((response) => {\n            if (processUpdates) {\n                stateManager.processUpdates(JSON.parse(response.data));\n            }\n            return;\n        })\n        .catch(exception => {\n            window.console.error('AJAX error:', exception);\n        });\n\n    }\n\n    _updateChecklistItemCategory(stateManager, itemId) {\n        const state = stateManager.state;\n        const itemObject = state.checklistitems.get(itemId);\n\n        // State always contains exactly one master checklist (architectural guarantee)\n        // Access via activechecklist.id (already contains master ID) (Moodle pattern: always know the ID)\n        const masterChecklist = state.masterchecklists.get(state.activechecklist.id);\n\n        const formDataObj = {\n            itemid: itemObject.id,\n            masterid: masterChecklist.id,\n            title: itemObject.title,\n            categoryid: itemObject.categoryid,\n            roomid: itemObject.roomid,\n            roleid: itemObject.roleid,\n            action: 'put',\n        };\n\n        const mutationData = {\n            formData: formDataObj,\n            formType: 'item'\n        };\n\n        this._callDynamicForm(stateManager, mutationData, false);\n    }\n\n    reOrderCategoryItems(stateManager, data) {\n        const state = stateManager.state;\n\n        stateManager.setReadOnly(false);\n\n        // The item was moved to a different category. We need to update both categories.\n        if (data.parentId !== data.targetParentId) {\n            const sourceCategory = state.checklistcategories.get(data.parentId);\n            const targetCategory = state.checklistcategories.get(data.targetParentId);\n\n            if (!sourceCategory.items || !Array.isArray(sourceCategory.items)) {\n                sourceCategory.items = [];\n            }\n\n            if (!targetCategory.items || !Array.isArray(targetCategory.items)) {\n                targetCategory.items = [];\n            }\n\n            const idToMove = parseInt(data.id);\n            const targetId = parseInt(data.targetId);\n\n            sourceCategory.items = sourceCategory.items.filter(item => item !== idToMove);\n\n            const targetItems = [...targetCategory.items];\n            const existingTargetIndex = targetItems.indexOf(idToMove);\n\n            if (existingTargetIndex === -1) {\n                const targetIndex = targetItems.indexOf(targetId);\n\n                if (targetIndex !== -1) {\n                    targetItems.splice(targetIndex + 1, 0, idToMove);\n                } else {\n                    targetItems.push(idToMove);\n                }\n            }\n\n            targetCategory.items = targetItems;\n\n            const targetItem = state.checklistitems.get(idToMove);\n\n            targetItem.categoryid = parseInt(targetCategory.id);\n\n            this._updateChecklistItemCategory(stateManager, idToMove);\n\n        } else {\n            // The item was moved within the same category. We only need to update one category.\n            const category = state.checklistcategories.get(data.targetParentId);\n\n            if (!category.items || !Array.isArray(category.items)) {\n                category.items = [];\n            }\n\n            const currentItems = [...category.items];\n            const idToMove = parseInt(data.id);\n            const targetId = parseInt(data.targetId);\n\n            const currentIndex = currentItems.indexOf(idToMove);\n\n            if (currentIndex === -1) {\n                currentItems.push(idToMove);\n            }\n\n            const targetIndex = currentItems.indexOf(targetId);\n\n            if (targetIndex !== -1 && currentIndex !== -1) {\n                currentItems.splice(currentIndex, 1);\n\n                const newTargetIndex = currentItems.indexOf(targetId);\n\n                currentItems.splice(newTargetIndex + 1, 0, idToMove);\n            } else if (currentIndex !== -1) {\n                // Handle case where target is not found but current index exists.\n                currentItems.splice(currentIndex, 1);\n                currentItems.push(idToMove);\n            }\n\n            category.items = currentItems;\n\n        }\n\n        stateManager.setReadOnly(true);\n\n        const categoriesToUpdate = [];\n\n        categoriesToUpdate.push(data.targetParentId);\n\n        if (data.parentId !== data.targetParentId) {\n            categoriesToUpdate.push(data.parentId);\n        }\n\n        // State always contains exactly one master checklist (architectural guarantee)\n        // Access via activechecklist.id (already contains master ID) (Moodle pattern: always know the ID)\n        const masterChecklist = stateManager.state.masterchecklists.get(stateManager.state.activechecklist.id);\n\n        // Persist state changes.\n        categoriesToUpdate.forEach(categoryId => {\n            const category = stateManager.state.checklistcategories.get(categoryId);\n            const formDataObj = {\n                id: category.id,\n                masterid: masterChecklist.id,\n                name: category.name,\n                checklistitems: category.items,\n                action: 'put',\n            };\n\n            const mutationData = {\n                formData: formDataObj,\n                formType: 'category'\n            };\n\n            this._callDynamicForm(stateManager, mutationData, false);\n        });\n    }\n\n    reOrderCategories(stateManager, data) {\n        const state = stateManager.state;\n\n        // Get master checklist ID from DOM instead of hardcoding\n        const tableElement = document.querySelector('#mod-bookit-master-checklist-table');\n        const masterId = parseInt(tableElement.dataset.masterChecklistId);\n        const masterChecklist = state.masterchecklists.get(masterId);\n        if (!masterChecklist) {\n            window.console.error('Master checklist not found');\n            stateManager.setReadOnly(true);\n            return;\n        }\n\n        let categoryOrder = masterChecklist.mastercategoryorder ?\n            masterChecklist.mastercategoryorder.split(',').map(id => parseInt(id)) : [];\n\n        const idToMove = parseInt(data.id);\n        const targetId = parseInt(data.targetId);\n\n        categoryOrder = categoryOrder.filter(id => id !== idToMove);\n\n        const targetIndex = categoryOrder.indexOf(targetId);\n\n        if (targetIndex !== -1) {\n            categoryOrder.splice(targetIndex + 1, 0, idToMove);\n        } else {\n            categoryOrder.push(idToMove);\n        }\n\n        const updatedCategoryOrder = categoryOrder.join(',');\n\n        const formDataObj = {\n            id: data.parentId,\n            mastercategoryorder: updatedCategoryOrder,\n            action: 'put',\n        };\n\n        data.formData = formDataObj;\n        data.formType = 'master';\n\n        this._callDynamicForm(stateManager, data);\n    }\n\n    checklistitemCreated(stateManager, data) {\n        const state = stateManager.state;\n\n        stateManager.processUpdates(data);\n\n        stateManager.setReadOnly(false);\n        const category = state.checklistcategories.get(data[0].fields.category);\n        const currentItems = [...category.items];\n        currentItems.push(data[0].fields.id);\n        category.items = currentItems;\n        stateManager.setReadOnly(true);\n\n    }\n\n    checklistitemDeleted(stateManager, data) {\n        const state = stateManager.state;\n\n        stateManager.setReadOnly(false);\n\n        const category = state.checklistcategories.get(data.categoryid);\n\n        const currentItems = [...category.items];\n        const itemIndex = currentItems.indexOf(data.id);\n\n        if (itemIndex !== -1) {\n            currentItems.splice(itemIndex, 1);\n            category.items = currentItems;\n        }\n\n        stateManager.setReadOnly(true);\n    }\n\n    roomChanged(stateManager, data) {\n        const state = stateManager.state;\n\n        const optionsArray = Array.from(data.options);\n\n        stateManager.setReadOnly(false);\n\n        let tempArray = [];\n        optionsArray.forEach(option => {\n            tempArray.push({\n                id: option.value,\n                name: option.textContent\n            });\n        });\n\n        const hasNoSelection = tempArray.some(room => room.id === \"0\");\n        if (hasNoSelection) {\n            tempArray = tempArray.filter(room => room.id === \"0\");\n        }\n\n        // Clear the existing StateMap and add new elements\n        state.activeRoom.clear();\n        tempArray.forEach((room) => {\n            state.activeRoom.set(room.id, room);\n        });\n\n        stateManager.setReadOnly(true);\n    }\n\n    roleChanged(stateManager, data) {\n        const state = stateManager.state;\n\n        stateManager.setReadOnly(false);\n\n        state.activeRole.id = parseInt(data.id);\n\n        stateManager.setReadOnly(true);\n    }\n\n}"],"names":["masterChecklistStateEvent","_callDynamicForm","stateManager","data","processUpdates","type","formType","formData","URLSearchParams","toString","call","methodname","args","formdata","form","then","response","JSON","parse","catch","exception","window","console","error","_updateChecklistItemCategory","itemId","state","itemObject","checklistitems","get","masterChecklist","masterchecklists","activechecklist","id","mutationData","itemid","masterid","title","categoryid","roomid","roleid","action","reOrderCategoryItems","setReadOnly","parentId","targetParentId","sourceCategory","checklistcategories","targetCategory","items","Array","isArray","idToMove","parseInt","targetId","filter","item","targetItems","indexOf","targetIndex","splice","push","category","currentItems","currentIndex","newTargetIndex","categoriesToUpdate","forEach","categoryId","name","reOrderCategories","tableElement","document","querySelector","masterId","dataset","masterChecklistId","categoryOrder","mastercategoryorder","split","map","updatedCategoryOrder","join","formDataObj","checklistitemCreated","fields","checklistitemDeleted","itemIndex","roomChanged","optionsArray","from","options","tempArray","option","value","textContent","some","room","activeRoom","clear","set","roleChanged","activeRole"],"mappings":"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"}