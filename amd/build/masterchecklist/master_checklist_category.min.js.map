{"version":3,"file":"master_checklist_category.min.js","sources":["../../src/masterchecklist/master_checklist_category.js"],"sourcesContent":["import {BaseComponent, DragDrop} from 'core/reactive';\nimport {masterChecklistReactiveInstance} from 'mod_bookit/masterchecklist/master_checklist_reactive';\nimport {SELECTORS} from 'mod_bookit/masterchecklist/master_checklist_reactive';\nimport ModalForm from 'core_form/modalform';\nimport {getString} from 'core/str';\nimport ChecklistHelper from 'mod_bookit/helpers/checklist_helper';\nimport Notification from 'core/notification';\n\nexport default class extends BaseComponent {\n\n    create(descriptor) {\n        this.helper = new ChecklistHelper();\n\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + descriptor.element.dataset.bookitCategoryId;\n\n        this.selectors[categoryEditBtnSelector] =\n            `#edit-checklistcategory-${descriptor.element.dataset.bookitCategoryId}`;\n\n        const categoryTbodySelector = 'CATEGORY_TBODY_' + descriptor.element.dataset.bookitCategoryId;\n        this.selectors[categoryTbodySelector] =\n            `#bookit-master-checklist-tbody-category-${descriptor.element.dataset.bookitCategoryId}`;\n    }\n\n    static init(target, selectors) {\n        return new this({\n            element: document.querySelector(target),\n            reactive: masterChecklistReactiveInstance,\n            selectors: selectors || SELECTORS,\n        });\n    }\n\n    getWatchers() {\n\n        return [\n            {watch: 'checklistcategories.name:updated', handler: this._refreshEditButtonListener},\n            {watch: 'activeRole:updated', handler: this._handleFilterUpdate},\n            {watch: 'activeRoom:created', handler: this._handleFilterUpdate},\n            {watch: 'checklistitems:created', handler: this._handleFilterUpdate},\n            {watch: 'checklistitems.roomids:updated', handler: this._handleFilterUpdate},\n            {watch: 'checklistitems.roleids:updated', handler: this._handleFilterUpdate},\n\n            // Item rooms and roles watchers\n        ];\n    }\n\n    stateReady() {\n\n        this.dragdrop = new DragDrop(this);\n\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\n\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\n            e.preventDefault();\n            this._handleEditChecklistCategoryButtonClick(e);\n        });\n\n        document.addEventListener('mod_bookit:master_checklist_category_rendered', (e) => {\n\n            this._refreshEditButtonListener(e);\n        }, true);\n    }\n\n    destroy() {\n        if (this.dragdrop !== undefined) {\n            this.dragdrop.unregister();\n        }\n    }\n\n    validateDropData() {\n        return true;\n    }\n\n    async _handleEditChecklistCategoryButtonClick() {\n        // State always contains exactly one master checklist (architectural guarantee)\n        const masterChecklist = this.reactive.state.masterchecklists.values().next().value;\n\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\local\\\\form\\\\masterchecklist\\\\edit_checklist_category_form',\n            moduleName: 'mod_bookit/modal_delete_save_cancel',\n            args: {\n                id: this.element.dataset.bookitCategoryId,\n                masterid: masterChecklist.id,\n                checklistitems: JSON.stringify(\n                    this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId).items\n                ),\n            },\n            modalConfig: {\n                title: await getString('checklistcategory', 'mod_bookit'),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (response) => {\n            this.reactive.stateManager.processUpdates(response.detail);\n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n\n            const deleteButton = modalForm.modal.getRoot().find('button[data-action=\"delete\"]');\n\n            deleteButton.on('click', async(e) => {\n                e.preventDefault();\n                const confirmTitle = await getString('confirm', 'core');\n                const confirmMessage = await getString('areyousure', 'core');\n                const deleteText = await getString('delete', 'core');\n\n                Notification.deleteCancel(\n                    confirmTitle,\n                    confirmMessage,\n                    deleteText,\n                    () => {\n                        modalForm.getFormNode().querySelector('input[name=\"action\"]').value = 'delete';\n                        modalForm.submitFormAjax();\n                    }\n                );\n            });\n        });\n\n        modalForm.show();\n    }\n\n    _refreshEditButtonListener() {\n        this.removeAllEventListeners();\n\n        const categoryEditBtnSelector = 'EDIT_CHECKLISTCATEGORY_BTN_' + this.element.dataset.bookitCategoryId;\n\n        this.addEventListener(this.getElement(this.selectors[categoryEditBtnSelector]), 'click', (e) => {\n            e.preventDefault();\n            this._handleEditChecklistCategoryButtonClick(e);\n        });\n    }\n\n    drop(dropdata) {\n        switch (dropdata.type) {\n            case 'item':\n                this._handleItemDrop(dropdata);\n                break;\n            case 'category':\n                this._handleCategoryDrop(dropdata);\n                break;\n            default:\n                throw new Error(`Unknown drop type: ${dropdata.type}`);\n        }\n    }\n\n    showDropZone() {\n        const root = document.querySelector('html');\n        const primaryColor = getComputedStyle(root).getPropertyValue('--primary');\n\n        this.element.style.boxShadow = `0px -5px 0px 0px ${primaryColor} inset`;\n        this.element.style.transition = 'box-shadow 0.1s ease';\n    }\n\n    hideDropZone() {\n        this.element.style.boxShadow = '';\n        this.element.style.backgroundBlendMode = '';\n        this.element.style.transition = '';\n    }\n\n    _handleItemDrop(dropdata) {\n\n        const categoryObject = this.reactive.state.checklistcategories.get(this.element.dataset.bookitCategoryId);\n\n        const categoryObjectItems = [...categoryObject.items];\n\n        const lastItemId = categoryObjectItems[categoryObjectItems.length - 1];\n\n        dropdata.targetId = parseInt(lastItemId);\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryId);\n\n        this.reactive.dispatch('reOrderCategoryItems', dropdata);\n\n        const itemObject = this.reactive.state.checklistitems.get(dropdata.id);\n\n        const itemElement = document.getElementById(`bookit-master-checklist-item-${itemObject.id}`);\n\n        const itemHasChangedParent = dropdata.parentId !== dropdata.targetParentId;\n\n        if (itemHasChangedParent) {\n            itemElement.dataset.bookitChecklistitemCategoryid = dropdata.targetParentId;\n        }\n\n        this.element.append(itemElement);\n    }\n\n\n    _handleCategoryDrop(dropdata) {\n\n        dropdata.targetId = parseInt(this.element.dataset.bookitCategoryId);\n        dropdata.targetParentId = parseInt(this.element.dataset.bookitCategoryMasterid);\n\n        this.reactive.dispatch('reOrderCategories', dropdata);\n\n        const categoryObject = this.reactive.state.checklistcategories.get(dropdata.id);\n\n        const categoryElement = document.getElementById(`bookit-master-checklist-tbody-category-${categoryObject.id}`);\n\n        const tableElement = document.querySelector(this.selectors.TABLE);\n\n        tableElement.insertBefore(categoryElement, this.element.nextElementSibling);\n\n    }\n\n     _handleFilterUpdate() {\n        const components = this.reactive.components;\n        const results = this.helper.findComponents(components, {\n            dataset: {bookitChecklistitemCategoryid: this.element.dataset.bookitCategoryId},\n            onlyFirst: false\n        });\n\n\n        if (!results || results.length === 0) {\n            const activeRooms = this.reactive.state.activeRoom;\n            const activeRoleId = this.reactive.state.activeRole.id;\n            const noRoomSelection = activeRooms.some(room => {\n                return room.id == 0;\n            });\n            if (activeRoleId == 0 && noRoomSelection) {\n                this.element.classList.remove('d-none');\n            }\n        } else {\n\n            var hasVisibleItems = false;\n            results.forEach((component) => {\n                const itemIsVisible = component.shouldBeVisible();\n                if (itemIsVisible) {\n                    hasVisibleItems = true;\n                }\n            });\n\n            if (!hasVisibleItems) {\n                this.element.classList.add('d-none');\n            } else {\n                this.element.classList.remove('d-none');\n            }\n        }\n\n    }\n\n}"],"names":["BaseComponent","create","descriptor","helper","ChecklistHelper","categoryEditBtnSelector","element","dataset","bookitCategoryId","selectors","categoryTbodySelector","target","this","document","querySelector","reactive","masterChecklistReactiveInstance","SELECTORS","getWatchers","watch","handler","_refreshEditButtonListener","_handleFilterUpdate","stateReady","dragdrop","DragDrop","addEventListener","getElement","e","preventDefault","_handleEditChecklistCategoryButtonClick","destroy","undefined","unregister","validateDropData","masterChecklist","state","masterchecklists","values","next","value","modalForm","ModalForm","formClass","moduleName","args","id","masterid","checklistitems","JSON","stringify","checklistcategories","get","items","modalConfig","title","events","FORM_SUBMITTED","response","stateManager","processUpdates","detail","LOADED","modal","getRoot","find","on","async","confirmTitle","confirmMessage","deleteText","deleteCancel","getFormNode","submitFormAjax","show","removeAllEventListeners","drop","dropdata","type","_handleItemDrop","_handleCategoryDrop","Error","showDropZone","root","primaryColor","getComputedStyle","getPropertyValue","style","boxShadow","transition","hideDropZone","backgroundBlendMode","categoryObjectItems","lastItemId","length","targetId","parseInt","targetParentId","dispatch","itemObject","itemElement","getElementById","parentId","bookitChecklistitemCategoryid","append","bookitCategoryMasterid","categoryObject","categoryElement","TABLE","insertBefore","nextElementSibling","components","results","findComponents","onlyFirst","hasVisibleItems","forEach","component","shouldBeVisible","classList","remove","add","activeRooms","activeRoom","activeRoleId","activeRole","noRoomSelection","some","room"],"mappings":"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"}