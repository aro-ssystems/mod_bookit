define("mod_bookit/master_checklist_item",["exports","core/reactive","mod_bookit/master_checklist_reactive","core_form/modalform","core/str","core/templates","core/notification"],(function(_exports,_reactive,_master_checklist_reactive,_modalform,_str,_templates,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_modalform=_interopRequireDefault(_modalform),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);class _class extends _reactive.BaseComponent{create(descriptor){const itemEditBtnSelector="EDIT_CHECKLISTITEM_BTN_"+descriptor.element.dataset.bookitChecklistitemId;this.selectors[itemEditBtnSelector]="#edit-checklistitem-".concat(descriptor.element.dataset.bookitChecklistitemId)}static init(target,selectors){return new this({element:document.querySelector(target),reactive:_master_checklist_reactive.masterChecklistReactiveInstance,selectors:selectors||_master_checklist_reactive.SELECTORS})}getWatchers(){return[]}stateReady(state){this.dragdrop=new _reactive.DragDrop(this);const itemEditBtnSelector="EDIT_CHECKLISTITEM_BTN_"+this.element.dataset.bookitChecklistitemId;this.addEventListener(this.getElement(this.selectors[itemEditBtnSelector]),"click",(e=>{e.preventDefault(),this._handleEditChecklistItemButtonClick(e)})),this.shouldBeVisible()}destroy(){void 0!==this.dragdrop&&this.dragdrop.unregister()}validateDropData(dropdata){return!0}drop(dropdata,event){switch(dropdata.type){case"item":this._handleItemDrop(dropdata,event);break;case"category":this._handleCategoryDrop(dropdata,event);break;default:throw new Error("Unknown drop type: ".concat(dropdata.type))}}showDropZone(dropdata,event){const root=document.querySelector("html"),primaryColor=getComputedStyle(root).getPropertyValue("--primary");switch(dropdata.type){case"item":this.element.style.boxShadow="0px -5px 0px 0px ".concat(primaryColor," inset"),this.element.style.transition="box-shadow 0.1s ease";break;case"category":const itemParentId=parseInt(this.element.dataset.bookitChecklistitemCategoryid),categoryParentElement=document.getElementById("bookit-master-checklist-tbody-category-".concat(itemParentId));parseInt(categoryParentElement.dataset.bookitCategoryActive||0)||(categoryParentElement.dataset.bookitCategoryActive=1);const categoryLastChild=categoryParentElement.lastElementChild;setTimeout((()=>{categoryParentElement.dataset.bookitCategoryActive=0}),5),categoryLastChild.style.boxShadow="0px -5px 0px 0px ".concat(primaryColor," inset"),categoryLastChild.style.transition="box-shadow 0.1s ease";break;default:throw new Error("Unknown drop type: ".concat(dropdata.type))}}hideDropZone(dropdata,event){switch(dropdata.type){case"item":this.element.style.boxShadow="",this.element.style.transition="";break;case"category":const itemParentId=parseInt(this.element.dataset.bookitChecklistitemCategoryid),categoryParentElement=document.getElementById("bookit-master-checklist-tbody-category-".concat(itemParentId)),categoryLastChild=categoryParentElement.lastElementChild;parseInt(categoryParentElement.dataset.bookitCategoryActive||0)||(categoryLastChild.style.boxShadow="",categoryLastChild.style.transition="");break;default:throw new Error("Unknown drop type: ".concat(dropdata.type))}}_handleItemDrop(dropdata,event){dropdata.targetId=parseInt(this.element.dataset.bookitChecklistitemId),dropdata.targetParentId=parseInt(this.element.dataset.bookitChecklistitemCategoryid),this.reactive.dispatch("reOrderCategoryItems",dropdata);const itemObject=this.reactive.state.checklistitems.get(dropdata.id),itemElement=document.getElementById("bookit-master-checklist-item-".concat(itemObject.id));dropdata.parentId!==dropdata.targetParentId&&(itemElement.dataset.bookitChecklistitemCategoryid=dropdata.targetParentId),this.element.parentNode.insertBefore(itemElement,this.element.nextElementSibling)}_handleCategoryDrop(dropdata,event){const categoryElement=document.getElementById("bookit-master-checklist-tbody-category-".concat(dropdata.id));dropdata.targetId=this.element.dataset.bookitChecklistitemCategoryid,dropdata.targetParentId=categoryElement.dataset.bookitCategoryMasterid,this.reactive.dispatch("reOrderCategories",dropdata);const tableElement=document.querySelector(this.selectors.TABLE);categoryElement.dataset.bookitCategoryActive=1,this.hideDropZone(dropdata,event),tableElement.insertBefore(categoryElement,this.element.parentNode.nextElementSibling)}async _handleEditChecklistItemButtonClick(event){const modalForm=new _modalform.default({formClass:"mod_bookit\\form\\edit_checklist_item_form",moduleName:"mod_bookit/modal_delete_save_cancel",args:{masterid:1,itemid:event.currentTarget.value,categories:Array.from(this.reactive.state.checklistcategories.values())},modalConfig:{title:await(0,_str.getString)("checklistitem","mod_bookit")}});modalForm.addEventListener(modalForm.events.FORM_SUBMITTED,(response=>{if(this.reactive.stateManager.processUpdates(response.detail),"delete"===response.detail[0].action)return this.reactive.dispatch("checklistitemDeleted",{id:parseInt(response.detail[0].fields.id),categoryid:parseInt(this.element.dataset.bookitChecklistitemCategoryid)}),void this.remove();const parentId=parseInt(this.element.dataset.bookitChecklistitemCategoryid),updatedParentId=parseInt(response.detail[0].fields.categoryid);if(parentId!==updatedParentId){const lastItemOfParentCategoryId=[...this.reactive.state.checklistcategories.get(response.detail[0].fields.categoryid).items].pop(),data={id:parseInt(this.element.dataset.bookitChecklistitemId),type:"item",parentId:parentId,targetId:lastItemOfParentCategoryId,targetParentId:updatedParentId};this.reactive.dispatch("reOrderCategoryItems",data),this.element.dataset.bookitChecklistitemCategoryid=data.targetParentId;document.getElementById("bookit-master-checklist-tbody-category-".concat(data.targetParentId)).append(this.element)}})),modalForm.addEventListener(modalForm.events.LOADED,(response=>{modalForm.modal.getRoot().find('button[data-action="delete"]').on("click",(async e=>{e.preventDefault();const confirmTitle=await(0,_str.getString)("confirm","core"),confirmMessage=await(0,_str.getString)("areyousure","core"),deleteText=await(0,_str.getString)("delete","core");_notification.default.deleteCancel(confirmTitle,confirmMessage,deleteText,(()=>{modalForm.getFormNode().querySelector('input[name="action"]').value="delete",modalForm.submitFormAjax()}),(()=>{}))})),setTimeout((()=>{this._addResetButtonsToNotificationEditors(modalForm)}),this.constructor.MODAL_TIMEOUT_MS),setTimeout((()=>{this._addRequiredIconsToNotificationFields(modalForm)}),this.constructor.MODAL_TIMEOUT_MS)})),modalForm.addEventListener(modalForm.events.SERVER_VALIDATION_ERROR,(response=>{setTimeout((()=>{this._addResetButtonsToNotificationEditors(modalForm),this._addRequiredIconsToNotificationFields(modalForm)}),this.constructor.MODAL_TIMEOUT_MS)})),modalForm.show()}_addRequiredIconsToNotificationFields(modalForm){["before_due","when_due","overdue","when_done"].forEach((type=>{const recipientElement=modalForm.getFormNode().querySelector('[id^="fitem_id_'.concat(type,'_recipient_"]'));if(recipientElement){const firstDiv=recipientElement.firstElementChild;if(firstDiv){const formLabelAddon=firstDiv.querySelector(".form-label-addon");if(formLabelAddon&&formLabelAddon.firstElementChild){const anchorElement=formLabelAddon.firstElementChild;this._addRequiredIcon(anchorElement,type,"recipient")}}}const timeElement=modalForm.getFormNode().querySelector('[id^="fitem_id_'.concat(type,'_time_"]'));if(timeElement){const firstDiv=timeElement.firstElementChild;if(firstDiv){const formLabelAddon=firstDiv.querySelector(".form-label-addon");if(formLabelAddon&&formLabelAddon.firstElementChild){const anchorElement=formLabelAddon.firstElementChild;this._addRequiredIcon(anchorElement,type,"time")}}}const messagetextElement=modalForm.getFormNode().querySelector('[id^="fitem_id_'.concat(type,'_messagetext_"]'));if(messagetextElement){const firstDiv=messagetextElement.firstElementChild;if(firstDiv){const formLabelAddon=firstDiv.querySelector(".form-label-addon");if(formLabelAddon&&formLabelAddon.firstElementChild){const anchorElement=formLabelAddon.firstElementChild;this._addRequiredIcon(anchorElement,type,"messagetext")}}}}))}_addRequiredIcon(anchorElement,type,fieldType){_templates.default.renderForPromise("core/pix_icon_fontawesome",{key:"fa-circle-exclamation",title:"Required",alt:"Required field",extraclasses:"fa text-danger fa-fw","aria-hidden":!1,unmappedIcon:!1}).then((result=>{const iconHtml=result.html,requiredIconHtml='<div class="text-danger" title="Required" aria-hidden="true">'.concat(iconHtml,"</div>");anchorElement.insertAdjacentHTML("beforebegin",requiredIconHtml)})).catch((error=>{window.console.log("Template error for ".concat(type,"_").concat(fieldType,":"),error)}))}_addResetButtonsToNotificationEditors(modalForm){["before_due","when_due","overdue","when_done"].forEach((type=>{const resetButton=modalForm.getFormNode().querySelector('button[name="'.concat(type,'_reset"]'));resetButton&&resetButton.addEventListener("click",(async e=>{e.preventDefault();try{const confirmTitle=await(0,_str.getString)("confirm","core"),confirmMessage=await(0,_str.getString)("resetmessagetoconfirm","mod_bookit");_notification.default.deleteCancel(confirmTitle,confirmMessage,await(0,_str.getString)("reset","core"),(async()=>{await this._performReset(modalForm,type)}),(()=>{}))}catch(error){window.console.error("Error showing confirmation dialog:",error)}}))}))}async _performReset(modalForm,type){const defaultMessage=await(0,_str.getString)("customtemplatedefaultmessage_".concat(type),"mod_bookit"),editorSelector='[name="'.concat(type,'_messagetext[text]"]'),textarea=modalForm.getFormNode().querySelector(editorSelector);if(textarea&&(textarea.value=defaultMessage,textarea.dispatchEvent(new Event("input",{bubbles:!0})),textarea.dispatchEvent(new Event("change",{bubbles:!0})),window.M&&window.M.editor_atto&&textarea.id)){const editorInstance=window.M.editor_atto.get(textarea.id);editorInstance&&editorInstance.updateOriginal()}if(window.tinymce){const editorId=null==textarea?void 0:textarea.id;if(editorId){const editor=window.tinymce.get(editorId);editor&&(editor.setContent(defaultMessage),editor.save())}}}shouldBeVisible(){const activeRoomId=this.reactive.state.activeRoom.id,activeRoleId=this.reactive.state.activeRole.id,itemId=parseInt(this.element.dataset.bookitChecklistitemId),stateItem=this.reactive.state.checklistitems.get(itemId),roomIds=stateItem.roomids,roleIds=stateItem.roleids;var isInRoom=!1;(0==activeRoomId||roomIds.includes(activeRoomId.toString()))&&(isInRoom=!0);var hasRole=!1;(0==activeRoleId||roleIds.includes(activeRoleId.toString()))&&(hasRole=!0);const shouldBeVisible=isInRoom&&hasRole;return shouldBeVisible?this.element.classList.remove("d-none"):this.element.classList.add("d-none"),shouldBeVisible}}var obj,key,value;return _exports.default=_class,value=500,(key="MODAL_TIMEOUT_MS")in(obj=_class)?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,_exports.default}));

//# sourceMappingURL=master_checklist_item.min.js.map