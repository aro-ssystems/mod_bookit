{"version":3,"file":"base_checklist_category.min.js","sources":["../../src/checklist/base_checklist_category.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Base checklist category component.\n *\n * Abstract base class for category components providing common functionality:\n * - Item management and rendering\n * - Modal form handling\n * - Event listeners for add/edit/delete actions\n * - Config-driven specialization\n *\n * @module mod_bookit/checklist/base_checklist_category\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\n\n/**\n * Base checklist category component.\n *\n * Specializations must implement:\n * - getConfig(): Return configuration object\n * - getItemComponent(): Return item component class\n *\n * Optional overrides:\n * - _renderCategoryRow(): Custom category row rendering\n * - _getCustomWatchers(): Add custom state watchers\n */\nexport default class BaseChecklistCategory extends BaseComponent {\n    /**\n     * Create component.\n     *\n     * @param {Object} options - Component options\n     * @param {HTMLElement} options.element - Parent container element\n     */\n    create({element}) {\n        this.parentElement = element;\n        this.categoryElement = null;\n        this.itemComponents = new Map();\n\n        // Store category ID from DOM - will get data from state in stateReady()\n        this.categoryId = parseInt(element.dataset.categoryid);\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n\n        const baseWatchers = [\n            {watch: `${itemsKey}:created`, handler: this._handleItemCreated},\n            {watch: `${itemsKey}.categoryid:updated`, handler: this._handleItemCategoryChanged},\n            {watch: `${itemsKey}:deleted`, handler: this._handleItemDeleted},\n        ];\n\n        // Allow specializations to add custom watchers\n        if (this._getCustomWatchers) {\n            return [...baseWatchers, ...this._getCustomWatchers()];\n        }\n\n        return baseWatchers;\n    }\n\n    /**\n     * Get configuration object.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Object} Configuration object with:\n     *   - categoriesStateKey: State key for categories (default: 'categories')\n     *   - itemsStateKey: State key for items (default: 'items')\n     *   - itemType: Name of item type (e.g., 'resource', 'checklistitem')\n     *   - itemModalForm: Full class name for item modal form\n     *   - categoryModalForm: Full class name for category modal form\n     *   - templates: Object with template names\n     */\n    getConfig() {\n        throw new Error('getConfig() must be implemented by specialization');\n    }\n\n    /**\n     * Get item component class.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Class} Item component class\n     */\n    getItemComponent() {\n        throw new Error('getItemComponent() must be implemented by specialization');\n    }\n\n    /**\n     * Initialize state ready.\n     */\n    stateReady() {\n\n        // Now we can access state and get category data\n        const config = this.getConfig();\n        const categoriesKey = config.categoriesStateKey || 'categories';\n        this.categoryData = this.reactive.state[categoriesKey].get(this.categoryId);\n\n        this.categoryElement = this.element;\n        this._initItemsFromDOM();\n        this._attachEventListeners();\n    }\n\n    /**\n     * Update category row.\n     *\n     * @param {Object} categoryData - Updated category data\n     */\n    _updateCategoryRow(categoryData) {\n        this.categoryData = categoryData;\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Update dataset\n        this.categoryElement.dataset.categoryName = categoryData.name;\n        this.categoryElement.dataset.categoryDescription = categoryData.description || '';\n        this.categoryElement.dataset.categorySortorder = categoryData.sortorder || 0;\n\n        // Update row content\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"checklist-category-row\"]');\n        if (categoryRow) {\n            const nameCell = categoryRow.querySelector('[data-field=\"category-name\"]');\n            if (nameCell) {\n                nameCell.textContent = categoryData.name;\n            }\n        }\n    }\n\n    /**\n     * Initialize item components from existing DOM.\n     */\n    _initItemsFromDOM() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n        const state = this.reactive.state;\n        const itemRegion = config.itemRegion || 'checklist-item-row';\n        const itemElements = this.categoryElement.querySelectorAll(`[data-region=\"${itemRegion}\"]`);\n\n        itemElements.forEach(itemElement => {\n            const itemId = parseInt(itemElement.dataset.itemid);\n            const itemData = state[itemsKey].get(itemId);\n\n            if (itemData && itemData.categoryid === this.categoryData.id) {\n                const ItemComponent = this.getItemComponent();\n                const itemComponent = new ItemComponent({\n                    element: itemElement,\n                    reactive: this.reactive,\n                });\n\n                this.itemComponents.set(itemData.id, itemComponent);\n            }\n        });\n    }\n\n    /**\n     * Render items in this category.\n     */\n    async _renderItems() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n\n        // Clear existing item rows (keep category row)\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"checklist-category-row\"]');\n        this.categoryElement.innerHTML = '';\n        if (categoryRow) {\n            this.categoryElement.appendChild(categoryRow);\n        }\n        this.itemComponents.clear();\n\n        // Get items from state\n        const state = this.reactive.state;\n        const items = Array.from(state[itemsKey].values())\n            .filter(item => item.categoryid === this.categoryData.id)\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Render each item\n        for (const itemData of items) {\n            const ItemComponent = this.getItemComponent();\n            const itemComponent = new ItemComponent({\n                element: this.categoryElement,\n                reactive: this.reactive,\n                itemData: itemData,\n            });\n            // Explicitly call render for dynamically created items\n            if (itemComponent._render) {\n                await itemComponent._render();\n            }\n            this.itemComponents.set(itemData.id, itemComponent);\n        }\n    }\n\n    /**\n     * Handle item created.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - New item data\n     */\n    async _handleItemCreated({element}) {\n        if (element.categoryid === this.categoryData.id) {\n            await this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item category changed.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    async _handleItemCategoryChanged({element}) {\n        const hadItem = this.itemComponents.has(element.id);\n        const shouldHaveItem = element.categoryid === this.categoryData.id;\n\n        if (hadItem !== shouldHaveItem) {\n            await this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted item data\n     */\n    _handleItemDeleted({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component) {\n            if (component.unregister) {\n                component.unregister();\n            }\n            this.itemComponents.delete(element.id);\n        }\n\n        // Remove item element from DOM\n        const itemElement = this.categoryElement.querySelector(\n            `[data-region=\"checklist-item-row\"][data-itemid=\"${element.id}\"]`\n        );\n        if (itemElement) {\n            itemElement.remove();\n        }\n    }\n\n    /**\n     * Replace rendered item.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    _replaceRenderedItem({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component && component._updateRow) {\n            component._updateRow(element);\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Add Item button\n        const addBtn = this.categoryElement.querySelector('[data-action=\"add-item\"]');\n        if (addBtn) {\n            this.addEventListener(addBtn, 'click', this._handleAddItem.bind(this));\n        }\n\n        // Edit Category button\n        const editBtn = this.categoryElement.querySelector('[data-action=\"edit-category\"]');\n        if (editBtn) {\n            this.addEventListener(editBtn, 'click', this._handleEdit.bind(this));\n        }\n\n        // Delete Category button\n        const deleteBtn = this.categoryElement.querySelector('[data-action=\"delete-category\"]');\n        if (deleteBtn) {\n            this.addEventListener(deleteBtn, 'click', this._handleDelete.bind(this));\n        }\n    }\n\n    /**\n     * Handle add item.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleAddItem(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const modalForm = new ModalForm({\n            formClass: config.itemModalForm,\n            args: {\n                id: 0,\n                categoryid: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await getString(`add${config.itemType}`, 'mod_bookit'),\n            },\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('itemsUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle edit category.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleEdit(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const modalForm = new ModalForm({\n            formClass: config.categoryModalForm,\n            args: {id: this.categoryData.id},\n            modalConfig: {\n                title: await getString('editcategory', 'mod_bookit'),\n            },\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('categoriesUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle delete category.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleDelete(event) {\n        event.preventDefault();\n\n        const confirmed = await Notification.confirm(\n            await getString('confirm', 'core'),\n            await getString('deletecategory_confirm', 'mod_bookit'),\n            await getString('delete', 'core'),\n            await getString('cancel', 'core')\n        );\n\n        if (confirmed) {\n            this.reactive.dispatch('categoriesDeleted', {fields: {id: this.categoryData.id}});\n        }\n    }\n}\n"],"names":["BaseChecklistCategory","BaseComponent","create","element","parentElement","categoryElement","itemComponents","Map","categoryId","parseInt","dataset","categoryid","getWatchers","itemsKey","this","getConfig","itemsStateKey","baseWatchers","watch","handler","_handleItemCreated","_handleItemCategoryChanged","_handleItemDeleted","_getCustomWatchers","Error","getItemComponent","stateReady","categoriesKey","categoriesStateKey","categoryData","reactive","state","get","_initItemsFromDOM","_attachEventListeners","_updateCategoryRow","categoryName","name","categoryDescription","description","categorySortorder","sortorder","categoryRow","querySelector","nameCell","textContent","config","itemRegion","querySelectorAll","forEach","itemElement","itemId","itemid","itemData","id","itemComponent","set","innerHTML","appendChild","clear","items","Array","from","values","filter","item","sort","a","b","_render","_renderItems","has","component","unregister","delete","remove","_replaceRenderedItem","_updateRow","addBtn","addEventListener","_handleAddItem","bind","editBtn","_handleEdit","deleteBtn","_handleDelete","event","preventDefault","modalForm","ModalForm","formClass","itemModalForm","args","modalConfig","title","itemType","returnFocus","currentTarget","events","FORM_SUBMITTED","e","response","detail","result","dispatch","fields","data","show","categoryModalForm","Notification","confirm"],"mappings":"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"}