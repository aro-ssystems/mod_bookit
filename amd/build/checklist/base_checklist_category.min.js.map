{"version":3,"file":"base_checklist_category.min.js","sources":["../../src/checklist/base_checklist_category.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Base checklist category component.\n *\n * Abstract base class for category components providing common functionality:\n * - Item management and rendering\n * - Modal form handling\n * - Event listeners for add/edit/delete actions\n * - Config-driven specialization\n *\n * @module mod_bookit/checklist/base_checklist_category\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\n\n/**\n * Base checklist category component.\n *\n * Specializations must implement:\n * - getConfig(): Return configuration object\n * - getItemComponent(): Return item component class\n *\n * Optional overrides:\n * - _renderCategoryRow(): Custom category row rendering\n * - _getCustomWatchers(): Add custom state watchers\n */\nexport default class BaseChecklistCategory extends BaseComponent {\n    /**\n     * Create component.\n     *\n     * @param {Object} options - Component options\n     * @param {HTMLElement} options.element - Parent container element\n     */\n    create({element}) {\n        this.parentElement = element;\n        this.categoryElement = null;\n        this.itemComponents = new Map();\n\n        // Extract category data from DOM\n        const categoryId = parseInt(element.dataset.categoryid);\n        const config = this.getConfig();\n        const categoriesKey = config.categoriesStateKey || 'categories';\n        this.categoryData = this.reactive.state[categoriesKey].get(categoryId);\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n\n        const baseWatchers = [\n            {watch: `${itemsKey}:created`, handler: this._handleItemCreated},\n            {watch: `${itemsKey}.categoryid:updated`, handler: this._handleItemCategoryChanged},\n            {watch: `${itemsKey}:deleted`, handler: this._handleItemDeleted},\n        ];\n\n        // Allow specializations to add custom watchers\n        if (this._getCustomWatchers) {\n            return [...baseWatchers, ...this._getCustomWatchers()];\n        }\n\n        return baseWatchers;\n    }\n\n    /**\n     * Get configuration object.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Object} Configuration object with:\n     *   - categoriesStateKey: State key for categories (default: 'categories')\n     *   - itemsStateKey: State key for items (default: 'items')\n     *   - itemType: Name of item type (e.g., 'resource', 'checklistitem')\n     *   - itemModalForm: Full class name for item modal form\n     *   - categoryModalForm: Full class name for category modal form\n     *   - templates: Object with template names\n     */\n    getConfig() {\n        throw new Error('getConfig() must be implemented by specialization');\n    }\n\n    /**\n     * Get item component class.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Class} Item component class\n     */\n    getItemComponent() {\n        throw new Error('getItemComponent() must be implemented by specialization');\n    }\n\n    /**\n     * Initialize state ready.\n     */\n    stateReady() {\n        this.categoryElement = this.element;\n        this._initItemsFromDOM();\n        this._attachEventListeners();\n    }\n\n    /**\n     * Update category row.\n     *\n     * @param {Object} categoryData - Updated category data\n     */\n    _updateCategoryRow(categoryData) {\n        this.categoryData = categoryData;\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Update dataset\n        this.categoryElement.dataset.categoryName = categoryData.name;\n        this.categoryElement.dataset.categoryDescription = categoryData.description || '';\n        this.categoryElement.dataset.categorySortorder = categoryData.sortorder || 0;\n\n        // Update row content\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"checklist-category-row\"]');\n        if (categoryRow) {\n            const nameCell = categoryRow.querySelector('[data-field=\"category-name\"]');\n            if (nameCell) {\n                nameCell.textContent = categoryData.name;\n            }\n        }\n    }\n\n    /**\n     * Initialize item components from existing DOM.\n     */\n    _initItemsFromDOM() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n        const state = this.reactive.state;\n        const itemElements = this.categoryElement.querySelectorAll('[data-region=\"checklist-item-row\"]');\n\n        itemElements.forEach(itemElement => {\n            const itemId = parseInt(itemElement.dataset.itemid);\n            const itemData = state[itemsKey].get(itemId);\n\n            if (itemData && itemData.categoryid === this.categoryData.id) {\n                const ItemComponent = this.getItemComponent();\n                const itemComponent = new ItemComponent({\n                    element: itemElement,\n                    reactive: this.reactive,\n                });\n\n                this.itemComponents.set(itemData.id, itemComponent);\n            }\n        });\n    }\n\n    /**\n     * Render items in this category.\n     */\n    async _renderItems() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n\n        // Clear existing item rows (keep category row)\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"checklist-category-row\"]');\n        this.categoryElement.innerHTML = '';\n        if (categoryRow) {\n            this.categoryElement.appendChild(categoryRow);\n        }\n        this.itemComponents.clear();\n\n        // Get items from state\n        const state = this.reactive.state;\n        const items = Array.from(state[itemsKey].values())\n            .filter(item => item.categoryid === this.categoryData.id)\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Render each item\n        for (const itemData of items) {\n            const ItemComponent = this.getItemComponent();\n            const itemComponent = new ItemComponent({\n                element: this.categoryElement,\n                reactive: this.reactive,\n                itemData: itemData,\n            });\n            // Explicitly call render for dynamically created items\n            if (itemComponent._render) {\n                await itemComponent._render();\n            }\n            this.itemComponents.set(itemData.id, itemComponent);\n        }\n    }\n\n    /**\n     * Handle item created.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - New item data\n     */\n    async _handleItemCreated({element}) {\n        if (element.categoryid === this.categoryData.id) {\n            await this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item category changed.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    async _handleItemCategoryChanged({element}) {\n        const hadItem = this.itemComponents.has(element.id);\n        const shouldHaveItem = element.categoryid === this.categoryData.id;\n\n        if (hadItem !== shouldHaveItem) {\n            await this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted item data\n     */\n    _handleItemDeleted({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component) {\n            if (component.unregister) {\n                component.unregister();\n            }\n            this.itemComponents.delete(element.id);\n        }\n\n        // Remove item element from DOM\n        const itemElement = this.categoryElement.querySelector(\n            `[data-region=\"checklist-item-row\"][data-itemid=\"${element.id}\"]`\n        );\n        if (itemElement) {\n            itemElement.remove();\n        }\n    }\n\n    /**\n     * Replace rendered item.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    _replaceRenderedItem({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component && component._updateRow) {\n            component._updateRow(element);\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Add Item button\n        const addBtn = this.categoryElement.querySelector('[data-action=\"add-item\"]');\n        if (addBtn) {\n            this.addEventListener(addBtn, 'click', this._handleAddItem.bind(this));\n        }\n\n        // Edit Category button\n        const editBtn = this.categoryElement.querySelector('[data-action=\"edit-category\"]');\n        if (editBtn) {\n            this.addEventListener(editBtn, 'click', this._handleEdit.bind(this));\n        }\n\n        // Delete Category button\n        const deleteBtn = this.categoryElement.querySelector('[data-action=\"delete-category\"]');\n        if (deleteBtn) {\n            this.addEventListener(deleteBtn, 'click', this._handleDelete.bind(this));\n        }\n    }\n\n    /**\n     * Handle add item.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleAddItem(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const modalForm = new ModalForm({\n            formClass: config.itemModalForm,\n            args: {\n                id: 0,\n                categoryid: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await getString(`add${config.itemType}`, 'mod_bookit'),\n            },\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('itemsUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle edit category.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleEdit(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const modalForm = new ModalForm({\n            formClass: config.categoryModalForm,\n            args: {id: this.categoryData.id},\n            modalConfig: {\n                title: await getString('editcategory', 'mod_bookit'),\n            },\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('categoriesUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle delete category.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleDelete(event) {\n        event.preventDefault();\n\n        const confirmed = await Notification.confirm(\n            await getString('confirm', 'core'),\n            await getString('deletecategory_confirm', 'mod_bookit'),\n            await getString('delete', 'core'),\n            await getString('cancel', 'core')\n        );\n\n        if (confirmed) {\n            this.reactive.dispatch('categoriesDeleted', {fields: {id: this.categoryData.id}});\n        }\n    }\n}\n"],"names":["BaseChecklistCategory","BaseComponent","create","element","parentElement","categoryElement","itemComponents","Map","categoryId","parseInt","dataset","categoryid","categoriesKey","this","getConfig","categoriesStateKey","categoryData","reactive","state","get","getWatchers","itemsKey","itemsStateKey","baseWatchers","watch","handler","_handleItemCreated","_handleItemCategoryChanged","_handleItemDeleted","_getCustomWatchers","Error","getItemComponent","stateReady","_initItemsFromDOM","_attachEventListeners","_updateCategoryRow","categoryName","name","categoryDescription","description","categorySortorder","sortorder","categoryRow","querySelector","nameCell","textContent","querySelectorAll","forEach","itemElement","itemId","itemid","itemData","id","itemComponent","set","innerHTML","appendChild","clear","items","Array","from","values","filter","item","sort","a","b","_render","_renderItems","has","component","unregister","delete","remove","_replaceRenderedItem","_updateRow","addBtn","addEventListener","_handleAddItem","bind","editBtn","_handleEdit","deleteBtn","_handleDelete","event","preventDefault","config","modalForm","ModalForm","formClass","itemModalForm","args","modalConfig","title","itemType","returnFocus","currentTarget","events","FORM_SUBMITTED","e","response","detail","result","dispatch","fields","data","show","categoryModalForm","Notification","confirm"],"mappings":"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"}