{"version":3,"file":"base_checklist_category.min.js","sources":["../../src/checklist/base_checklist_category.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Base checklist category component.\n *\n * Abstract base class for category components providing common functionality:\n * - Item management and rendering\n * - Modal form handling\n * - Event listeners for add/edit/delete actions\n * - Config-driven specialization\n *\n * @module mod_bookit/checklist/base_checklist_category\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\n\n/**\n * Base checklist category component.\n *\n * Specializations must implement:\n * - getConfig(): Return configuration object\n * - getItemComponent(): Return item component class\n *\n * Optional overrides:\n * - _renderCategoryRow(): Custom category row rendering\n * - _getCustomWatchers(): Add custom state watchers\n */\nexport default class BaseChecklistCategory extends BaseComponent {\n    /**\n     * Create component.\n     *\n     * @param {Object} options - Component options\n     * @param {HTMLElement} options.element - Parent container element\n     */\n    create({element}) {\n        window.console.log('BaseChecklistCategory.create() CALLED with element:', element);\n        this.parentElement = element;\n        this.categoryElement = null;\n        this.itemComponents = new Map();\n\n        // Store category ID from DOM - will get data from state in stateReady()\n        this.categoryId = parseInt(element.dataset.categoryid);\n        window.console.log('Category ID from DOM:', this.categoryId);\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n\n        const baseWatchers = [\n            {watch: `${itemsKey}:created`, handler: this._handleItemCreated},\n            {watch: `${itemsKey}.categoryid:updated`, handler: this._handleItemCategoryChanged},\n            {watch: `${itemsKey}:deleted`, handler: this._handleItemDeleted},\n        ];\n\n        // Allow specializations to add custom watchers\n        if (this._getCustomWatchers) {\n            return [...baseWatchers, ...this._getCustomWatchers()];\n        }\n\n        return baseWatchers;\n    }\n\n    /**\n     * Get configuration object.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Object} Configuration object with:\n     *   - categoriesStateKey: State key for categories (default: 'categories')\n     *   - itemsStateKey: State key for items (default: 'items')\n     *   - itemType: Name of item type (e.g., 'resource', 'checklistitem')\n     *   - itemModalForm: Full class name for item modal form\n     *   - categoryModalForm: Full class name for category modal form\n     *   - templates: Object with template names\n     */\n    getConfig() {\n        throw new Error('getConfig() must be implemented by specialization');\n    }\n\n    /**\n     * Get item component class.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Class} Item component class\n     */\n    getItemComponent() {\n        throw new Error('getItemComponent() must be implemented by specialization');\n    }\n\n    /**\n     * Initialize state ready.\n     */\n    stateReady() {\n        window.console.log('BaseChecklistCategory.stateReady() CALLED');\n\n        // Now we can access state and get category data\n        const config = this.getConfig();\n        const categoriesKey = config.categoriesStateKey || 'categories';\n        this.categoryData = this.reactive.state[categoriesKey].get(this.categoryId);\n\n        window.console.log('this.element:', this.element);\n        window.console.log('this.categoryData:', this.categoryData);\n        this.categoryElement = this.element;\n        this._initItemsFromDOM();\n        this._attachEventListeners();\n    }\n\n    /**\n     * Update category row.\n     *\n     * @param {Object} categoryData - Updated category data\n     */\n    _updateCategoryRow(categoryData) {\n        this.categoryData = categoryData;\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Update dataset\n        this.categoryElement.dataset.categoryName = categoryData.name;\n        this.categoryElement.dataset.categoryDescription = categoryData.description || '';\n        this.categoryElement.dataset.categorySortorder = categoryData.sortorder || 0;\n\n        // Update row content\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"checklist-category-row\"]');\n        if (categoryRow) {\n            const nameCell = categoryRow.querySelector('[data-field=\"category-name\"]');\n            if (nameCell) {\n                nameCell.textContent = categoryData.name;\n            }\n        }\n    }\n\n    /**\n     * Initialize item components from existing DOM.\n     */\n    _initItemsFromDOM() {\n        window.console.log('BaseChecklistCategory._initItemsFromDOM() CALLED');\n        window.console.log('this.categoryElement:', this.categoryElement);\n        if (!this.categoryElement) {\n            window.console.log('NO categoryElement - RETURNING');\n            return;\n        }\n\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n        window.console.log('itemsKey:', itemsKey);\n        const state = this.reactive.state;\n        window.console.log('state[itemsKey]:', state[itemsKey]);\n        const itemRegion = config.itemRegion || 'checklist-item-row';\n        window.console.log('Looking for items with region:', itemRegion);\n        const itemElements = this.categoryElement.querySelectorAll(`[data-region=\"${itemRegion}\"]`);\n        window.console.log('Found', itemElements.length, 'item elements in DOM');\n\n        itemElements.forEach(itemElement => {\n            const itemId = parseInt(itemElement.dataset.itemid);\n            window.console.log('Processing item ID:', itemId, 'element:', itemElement);\n            const itemData = state[itemsKey].get(itemId);\n            window.console.log('Item data from state:', itemData);\n\n            if (itemData && itemData.categoryid === this.categoryData.id) {\n                window.console.log('Item belongs to this category, creating component');\n                const ItemComponent = this.getItemComponent();\n                window.console.log('ItemComponent class:', ItemComponent);\n                const itemComponent = new ItemComponent({\n                    element: itemElement,\n                    reactive: this.reactive,\n                });\n                window.console.log('Item component created:', itemComponent);\n\n                this.itemComponents.set(itemData.id, itemComponent);\n                window.console.log('Item component stored in map');\n            } else {\n                window.console.log('Item does NOT belong to this category or not found in state');\n            }\n        });\n        window.console.log('Total item components created:', this.itemComponents.size);\n    }\n\n    /**\n     * Render items in this category.\n     */\n    async _renderItems() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        const config = this.getConfig();\n        const itemsKey = config.itemsStateKey || 'items';\n\n        // Clear existing item rows (keep category row)\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"checklist-category-row\"]');\n        this.categoryElement.innerHTML = '';\n        if (categoryRow) {\n            this.categoryElement.appendChild(categoryRow);\n        }\n        this.itemComponents.clear();\n\n        // Get items from state\n        const state = this.reactive.state;\n        const items = Array.from(state[itemsKey].values())\n            .filter(item => item.categoryid === this.categoryData.id)\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Render each item\n        for (const itemData of items) {\n            const ItemComponent = this.getItemComponent();\n            const itemComponent = new ItemComponent({\n                element: this.categoryElement,\n                reactive: this.reactive,\n                itemData: itemData,\n            });\n            // Explicitly call render for dynamically created items\n            if (itemComponent._render) {\n                await itemComponent._render();\n            }\n            this.itemComponents.set(itemData.id, itemComponent);\n        }\n    }\n\n    /**\n     * Handle item created.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - New item data\n     */\n    async _handleItemCreated({element}) {\n        if (element.categoryid === this.categoryData.id) {\n            await this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item category changed.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    async _handleItemCategoryChanged({element}) {\n        const hadItem = this.itemComponents.has(element.id);\n        const shouldHaveItem = element.categoryid === this.categoryData.id;\n\n        if (hadItem !== shouldHaveItem) {\n            await this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted item data\n     */\n    _handleItemDeleted({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component) {\n            if (component.unregister) {\n                component.unregister();\n            }\n            this.itemComponents.delete(element.id);\n        }\n\n        // Remove item element from DOM\n        const itemElement = this.categoryElement.querySelector(\n            `[data-region=\"checklist-item-row\"][data-itemid=\"${element.id}\"]`\n        );\n        if (itemElement) {\n            itemElement.remove();\n        }\n    }\n\n    /**\n     * Replace rendered item.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    _replaceRenderedItem({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component && component._updateRow) {\n            component._updateRow(element);\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Add Item button\n        const addBtn = this.categoryElement.querySelector('[data-action=\"add-item\"]');\n        if (addBtn) {\n            this.addEventListener(addBtn, 'click', this._handleAddItem.bind(this));\n        }\n\n        // Edit Category button\n        const editBtn = this.categoryElement.querySelector('[data-action=\"edit-category\"]');\n        if (editBtn) {\n            this.addEventListener(editBtn, 'click', this._handleEdit.bind(this));\n        }\n\n        // Delete Category button\n        const deleteBtn = this.categoryElement.querySelector('[data-action=\"delete-category\"]');\n        if (deleteBtn) {\n            this.addEventListener(deleteBtn, 'click', this._handleDelete.bind(this));\n        }\n    }\n\n    /**\n     * Handle add item.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleAddItem(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const modalForm = new ModalForm({\n            formClass: config.itemModalForm,\n            args: {\n                id: 0,\n                categoryid: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await getString(`add${config.itemType}`, 'mod_bookit'),\n            },\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('itemsUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle edit category.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleEdit(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const modalForm = new ModalForm({\n            formClass: config.categoryModalForm,\n            args: {id: this.categoryData.id},\n            modalConfig: {\n                title: await getString('editcategory', 'mod_bookit'),\n            },\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('categoriesUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle delete category.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleDelete(event) {\n        event.preventDefault();\n\n        const confirmed = await Notification.confirm(\n            await getString('confirm', 'core'),\n            await getString('deletecategory_confirm', 'mod_bookit'),\n            await getString('delete', 'core'),\n            await getString('cancel', 'core')\n        );\n\n        if (confirmed) {\n            this.reactive.dispatch('categoriesDeleted', {fields: {id: this.categoryData.id}});\n        }\n    }\n}\n"],"names":["BaseChecklistCategory","BaseComponent","create","element","window","console","log","parentElement","categoryElement","itemComponents","Map","categoryId","parseInt","dataset","categoryid","this","getWatchers","itemsKey","getConfig","itemsStateKey","baseWatchers","watch","handler","_handleItemCreated","_handleItemCategoryChanged","_handleItemDeleted","_getCustomWatchers","Error","getItemComponent","stateReady","categoriesKey","categoriesStateKey","categoryData","reactive","state","get","_initItemsFromDOM","_attachEventListeners","_updateCategoryRow","categoryName","name","categoryDescription","description","categorySortorder","sortorder","categoryRow","querySelector","nameCell","textContent","config","itemRegion","itemElements","querySelectorAll","length","forEach","itemElement","itemId","itemid","itemData","id","ItemComponent","itemComponent","set","size","innerHTML","appendChild","clear","items","Array","from","values","filter","item","sort","a","b","_render","_renderItems","has","component","unregister","delete","remove","_replaceRenderedItem","_updateRow","addBtn","addEventListener","_handleAddItem","bind","editBtn","_handleEdit","deleteBtn","_handleDelete","event","preventDefault","modalForm","ModalForm","formClass","itemModalForm","args","modalConfig","title","itemType","returnFocus","currentTarget","events","FORM_SUBMITTED","e","response","detail","result","dispatch","fields","data","show","categoryModalForm","Notification","confirm"],"mappings":"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"}