{"version":3,"file":"base_checklist_container.min.js","sources":["../../src/checklist/base_checklist_container.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Base checklist container component.\n *\n * Abstract base class for checklist-style components providing common functionality:\n * - Reactive state management\n * - Category/item hierarchy\n * - Modal form handling\n * - Event listeners and watchers\n * - Config-driven specialization\n *\n * @module mod_bookit/checklist/base_checklist_container\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Base checklist container component.\n *\n * Specializations must implement:\n * - getConfig(): Return configuration object\n * - getCategoryComponent(): Return category component class\n *\n * Optional overrides:\n * - _getInitialData(element): Extract initial data from DOM\n * - _initializeCustomControls(): Add custom UI controls\n * - _getCustomWatchers(): Add custom state watchers\n */\nexport default class BaseChecklistContainer extends BaseComponent {\n    /**\n     * Create component.\n     *\n     * Called by BaseComponent constructor.\n     */\n    create() {\n        const config = this.getConfig();\n\n        // Initialize selectors\n        this.selectors = {\n            addCategoryBtn: config.selectors?.addCategoryBtn || '#add-category-btn',\n            addItemBtn: config.selectors?.addItemBtn || '#add-item-btn',\n            tableView: config.selectors?.tableView || '.mod-bookit-table-view',\n            ...config.selectors || {}\n        };\n\n        // Initialize component registry\n        this.categoryComponents = new Map();\n\n        // Cache localized strings\n        this.strings = {};\n        this._cacheStrings();\n    }\n\n    /**\n     * Initial state ready.\n     *\n     * Called when reactive state is ready.\n     */\n    stateReady() {\n        this._initializeCategoryComponents();\n        this._attachEventListeners();\n        if (this._initializeCustomControls) {\n            this._initializeCustomControls();\n        }\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        const config = this.getConfig();\n        const categoriesKey = config.categoriesStateKey || 'categories';\n        const itemsKey = config.itemsStateKey || 'items';\n\n        const baseWatchers = [\n            {watch: `${categoriesKey}:created`, handler: this._handleCategoryCreated},\n            {watch: `${categoriesKey}.name:updated`, handler: this._handleCategoryUpdated},\n            {watch: `${categoriesKey}.description:updated`, handler: this._handleCategoryUpdated},\n            {watch: `${categoriesKey}:deleted`, handler: this._handleCategoryDeleted},\n            {watch: `${itemsKey}:created`, handler: this._handleItemCreated},\n            {watch: `${itemsKey}.name:updated`, handler: this._replaceRenderedItem},\n            {watch: `${itemsKey}.description:updated`, handler: this._replaceRenderedItem},\n        ];\n\n        // Allow specializations to add custom watchers\n        if (this._getCustomWatchers) {\n            return [...baseWatchers, ...this._getCustomWatchers()];\n        }\n\n        return baseWatchers;\n    }\n\n    /**\n     * Get configuration object.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Object} Configuration object with:\n     *   - categoriesStateKey: State key for categories (default: 'categories')\n     *   - itemsStateKey: State key for items (default: 'items')\n     *   - itemType: Name of item type (e.g., 'resource', 'checklistitem')\n     *   - categoryModalForm: Full class name for category modal form\n     *   - itemModalForm: Full class name for item modal form\n     *   - selectors: Optional custom selectors\n     */\n    getConfig() {\n        throw new Error('getConfig() must be implemented by specialization');\n    }\n\n    /**\n     * Get category component class.\n     *\n     * Must be implemented by specializations.\n     *\n     * @return {Class} Category component class\n     */\n    getCategoryComponent() {\n        throw new Error('getCategoryComponent() must be implemented by specialization');\n    }\n\n    /**\n     * Initialize category components.\n     */\n    _initializeCategoryComponents() {\n        const config = this.getConfig();\n        const categoriesKey = config.categoriesStateKey || 'categories';\n        const categories = this.reactive.state[categoriesKey];\n\n        if (!categories) {\n            return;\n        }\n\n        categories.forEach((category, categoryId) => {\n            const categoryRegion = config.categoryRegion || 'checklist-category';\n            const categoryElement = this.getElement(`[data-region=\"${categoryRegion}\"][data-categoryid=\"${categoryId}\"]`);\n            if (categoryElement) {\n                const CategoryComponent = this.getCategoryComponent();\n                const instance = new CategoryComponent({\n                    element: categoryElement,\n                    reactive: this.reactive,\n                });\n                this.categoryComponents.set(categoryId, instance);\n            }\n        });\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        // Add category button\n        const addCategoryBtn = this.getElement(this.selectors.addCategoryBtn);\n        if (addCategoryBtn) {\n            this.addEventListener(addCategoryBtn, 'click', this._handleAddCategoryClick.bind(this));\n        }\n\n        // Add item button\n        const addItemBtn = this.getElement(this.selectors.addItemBtn);\n        if (addItemBtn) {\n            this.addEventListener(addItemBtn, 'click', this._handleAddItemClick.bind(this));\n        }\n    }\n\n    /**\n     * Handle category created.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - New category data\n     */\n    async _handleCategoryCreated({element}) {\n        await this._renderCategory(element);\n    }\n\n    /**\n     * Handle category updated.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated category data\n     */\n    _handleCategoryUpdated({element}) {\n        const component = this.categoryComponents.get(element.id);\n        if (component) {\n            component._updateCategoryRow(element);\n        }\n    }\n\n    /**\n     * Handle category deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted category data\n     */\n    _handleCategoryDeleted({element}) {\n        const component = this.categoryComponents.get(element.id);\n        if (component) {\n            component.unregister();\n            this.categoryComponents.delete(element.id);\n        }\n\n        const categoryElement = this.getElement(\n            `[data-region=\"checklist-category\"][data-categoryid=\"${element.id}\"]`\n        );\n        if (categoryElement) {\n            categoryElement.remove();\n        }\n    }\n\n    /**\n     * Handle item created.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - New item data\n     */\n    _handleItemCreated({element}) {\n        const component = this.categoryComponents.get(element.categoryid);\n        if (component) {\n            component._handleItemCreated({element});\n        }\n    }\n\n    /**\n     * Replace rendered item.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    _replaceRenderedItem({element}) {\n        const component = this.categoryComponents.get(element.categoryid);\n        if (component) {\n            component._replaceRenderedItem({element});\n        }\n    }\n\n    /**\n     * Render category.\n     *\n     * @param {Object} categoryData - Category data\n     */\n    async _renderCategory(categoryData) {\n        const tableView = this.getElement(this.selectors.tableView);\n        if (!tableView) {\n            return;\n        }\n\n        // Use specialization's render method if available\n        if (this._renderCategoryCustom) {\n            await this._renderCategoryCustom(categoryData, tableView);\n            return;\n        }\n\n        // Default rendering (can be overridden)\n        const CategoryComponent = this.getCategoryComponent();\n        const tempDiv = document.createElement('div');\n        tempDiv.innerHTML = `\n            <tbody data-region=\"checklist-category\" data-categoryid=\"${categoryData.id}\">\n                <tr data-region=\"checklist-category-row\">\n                    <td colspan=\"100\">${categoryData.name}</td>\n                </tr>\n            </tbody>\n        `;\n        const categoryElement = tempDiv.firstElementChild;\n        tableView.appendChild(categoryElement);\n\n        const instance = new CategoryComponent({\n            element: categoryElement,\n            reactive: this.reactive,\n        });\n        this.categoryComponents.set(categoryData.id, instance);\n    }\n\n    /**\n     * Handle add category button click.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleAddCategoryClick(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const contextId = this.selectors.contextId;\n\n        const modalForm = new ModalForm({\n            formClass: config.categoryModalForm,\n            args: {id: 0, contextid: contextId},\n            modalConfig: {title: await getString('addcategory', 'mod_bookit')},\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('categoriesUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle add item button click.\n     *\n     * @param {Event} event - Click event\n     */\n    async _handleAddItemClick(event) {\n        event.preventDefault();\n\n        const config = this.getConfig();\n        const contextId = this.selectors.contextId;\n\n        const modalForm = new ModalForm({\n            formClass: config.itemModalForm,\n            args: {id: 0, contextid: contextId},\n            modalConfig: {title: await getString(`add${config.itemType}`, 'mod_bookit')},\n            returnFocus: event.currentTarget,\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            const response = e.detail;\n            if (response.result === 'success') {\n                this.reactive.dispatch('itemsUpdated', {fields: response.data});\n            }\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Cache localized strings.\n     */\n    _cacheStrings() {\n        getString('active', 'core').then(str => {\n            this.strings.active = str;\n            return str;\n        }).catch(() => {\n            this.strings.active = 'Active';\n        });\n        getString('inactive', 'core').then(str => {\n            this.strings.inactive = str;\n            return str;\n        }).catch(() => {\n            this.strings.inactive = 'Inactive';\n        });\n    }\n}\n"],"names":["BaseChecklistContainer","BaseComponent","create","config","this","getConfig","selectors","addCategoryBtn","addItemBtn","tableView","categoryComponents","Map","strings","_cacheStrings","stateReady","_initializeCategoryComponents","_attachEventListeners","_initializeCustomControls","getWatchers","categoriesKey","categoriesStateKey","itemsKey","itemsStateKey","baseWatchers","watch","handler","_handleCategoryCreated","_handleCategoryUpdated","_handleCategoryDeleted","_handleItemCreated","_replaceRenderedItem","_getCustomWatchers","Error","getCategoryComponent","categories","reactive","state","forEach","category","categoryId","categoryRegion","categoryElement","getElement","instance","element","set","addEventListener","_handleAddCategoryClick","bind","_handleAddItemClick","_renderCategory","component","get","id","_updateCategoryRow","unregister","delete","remove","categoryid","categoryData","_renderCategoryCustom","CategoryComponent","tempDiv","document","createElement","innerHTML","name","firstElementChild","appendChild","event","preventDefault","contextId","modalForm","ModalForm","formClass","categoryModalForm","args","contextid","modalConfig","title","returnFocus","currentTarget","events","FORM_SUBMITTED","e","response","detail","result","dispatch","fields","data","show","itemModalForm","itemType","then","str","active","catch","inactive"],"mappings":"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"}