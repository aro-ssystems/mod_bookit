{"version":3,"file":"resource_category.min.js","sources":["../src/resource_category.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Resource category reactive component.\n *\n * @module mod_bookit/resource_category\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport Templates from 'core/templates';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\nimport ResourceItem from './resource_item';\n\n/**\n * Resource category component.\n */\nexport default class ResourceCategory extends BaseComponent {\n    /**\n     * Component descriptor for debugging.\n     *\n     * @return {string} Component name\n     */\n    static get componentName() {\n        return 'mod_bookit/resource_category';\n    }\n\n    /**\n     * Create component.\n     *\n     * @param {Object} options - Component options\n     * @param {HTMLElement} options.element - Parent container element\n     * @param {Object} options.categoryData - Category data\n     */\n    create({element, categoryData}) {\n        this.categoryData = categoryData;\n        this.categoryElement = null;\n        this.itemComponents = new Map();\n        this.parentElement = element;\n\n        // Note: _render() must be called explicitly when creating new categories.\n        // When initializing from existing DOM, categoryElement is set externally.\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        return [\n            {watch: `items:created`, handler: this._handleItemCreated},\n            {watch: `items.categoryid:updated`, handler: this._handleItemCategoryChanged},\n            {watch: `items:deleted`, handler: this._handleItemDeleted},\n        ];\n    }\n\n    /**\n     * Render category (table view: tbody with category row).\n     */\n    async _render() {\n        // Render category row.\n        const categoryRowHtml = await Templates.render('mod_bookit/resource_category_row', this.categoryData);\n\n        // Create tbody element for this category.\n        const tbody = document.createElement('tbody');\n        tbody.dataset.region = 'resource-category';\n        tbody.dataset.categoryid = this.categoryData.id;\n        tbody.dataset.categoryName = this.categoryData.name;\n        tbody.dataset.categoryDescription = this.categoryData.description || '';\n        tbody.dataset.categorySortorder = this.categoryData.sortorder || 0;\n        tbody.innerHTML = categoryRowHtml.trim();\n\n        this.categoryElement = tbody;\n        this.parentElement.appendChild(this.categoryElement);\n\n        this._renderItems();\n        this._attachEventListeners();\n    }\n\n    /**\n     * Render items in this category (table view: append rows to tbody).\n     * Used when creating new items dynamically.\n     */\n    async _renderItems() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Clear existing item rows (keep category row).\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"resource-category-row\"]');\n        this.categoryElement.innerHTML = '';\n        if (categoryRow) {\n            this.categoryElement.appendChild(categoryRow);\n        }\n        this.itemComponents.clear();\n\n        // Get items from state.\n        const state = this.reactive.state;\n        const items = Array.from(state.items.values())\n            .filter(item => item.categoryid === this.categoryData.id)\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Render each item as a table row.\n        for (const itemData of items) {\n            const itemComponent = new ResourceItem({\n                element: this.categoryElement,\n                reactive: this.reactive,\n                itemData: itemData,\n            });\n            // Explicitly call render for dynamically created items.\n            await itemComponent._render();\n            this.itemComponents.set(itemData.id, itemComponent);\n        }\n    }\n\n    /**\n     * Initialize item components from existing DOM.\n     * Called when attaching to pre-rendered HTML.\n     */\n    _initItemsFromDOM() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        const state = this.reactive.state;\n        const itemRows = this.categoryElement.querySelectorAll('tr[data-item-id]');\n\n        itemRows.forEach(itemRow => {\n            const itemId = parseInt(itemRow.dataset.itemId);\n            const itemData = state.items.get(itemId);\n\n            if (itemData && itemData.categoryid === this.categoryData.id) {\n                const itemComponent = new ResourceItem({\n                    element: this.categoryElement,\n                    reactive: this.reactive,\n                    itemData: itemData,\n                });\n                // Set existing DOM element instead of rendering.\n                itemComponent.itemElement = itemRow;\n                itemComponent._attachEventListeners();\n\n                this.itemComponents.set(itemData.id, itemComponent);\n            }\n        });\n    }\n\n    /**\n     * Handle item created.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - New item data\n     */\n    _handleItemCreated({element}) {\n        if (element.categoryid === this.categoryData.id) {\n            this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item category changed (item moved between categories).\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    _handleItemCategoryChanged({element}) {\n        // Check if item moved to/from this category.\n        const hadItem = this.itemComponents.has(element.id);\n        const shouldHaveItem = element.categoryid === this.categoryData.id;\n\n        if (hadItem !== shouldHaveItem) {\n            // Item moved - re-render.\n            this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted item data\n     */\n    _handleItemDeleted({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component) {\n            component.remove();\n            this.itemComponents.delete(element.id);\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Add Item.\n        const addBtn = this.categoryElement.querySelector('[data-action=\"add-item\"]');\n        if (addBtn) {\n            addBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this._handleAddItem();\n            });\n        }\n\n        // Edit Category.\n        const editBtn = this.categoryElement.querySelector('[data-action=\"edit-category\"]');\n        if (editBtn) {\n            editBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this._handleEdit();\n            });\n        }\n    }\n\n    /**\n     * Handle add item.\n     */\n    async _handleAddItem() {\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\form\\\\edit_resource_form',\n            args: {\n                categoryid: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await getString('resources:add_resource', 'mod_bookit'),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.dispatch('createItem', e.detail);\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle edit category.\n     */\n    async _handleEdit() {\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\form\\\\edit_resource_category_form',\n            moduleName: 'mod_bookit/modal_delete_save_cancel',\n            args: {\n                id: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await getString('resources:edit_category', 'mod_bookit'),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.stateManager.processUpdates(e.detail);\n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n            const deleteButton = modalForm.modal.getRoot().find('button[data-action=\"delete\"]');\n\n            deleteButton.on('click', async(e) => {\n                e.preventDefault();\n\n                // Check if category has resources.\n                const state = this.reactive.state;\n                const resourceCount = Array.from(state.items.values())\n                    .filter(item => item.categoryid === this.categoryData.id).length;\n\n                if (resourceCount > 0) {\n                    // Category has resources - show informative message.\n                    const errorTitle = await getString('error', 'core');\n                    const errorMessage = await getString('resources:category_has_resources', 'mod_bookit');\n\n                    Notification.alert(\n                        errorTitle,\n                        errorMessage\n                    );\n                    return;\n                }\n\n                // No resources - proceed with delete confirmation.\n                const confirmTitle = await getString('confirm', 'core');\n                const confirmMessage = await getString('areyousure', 'core');\n                const deleteText = await getString('delete', 'core');\n\n                Notification.deleteCancel(\n                    confirmTitle,\n                    confirmMessage,\n                    deleteText,\n                    () => {\n                        modalForm.getFormNode().querySelector('input[name=\"action\"]').value = 'delete';\n                        modalForm.submitFormAjax();\n                    }\n                );\n            });\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Update with new data (re-render category row).\n     *\n     * @param {Object} newData - Updated category data\n     */\n    update(newData) {\n        this.categoryData = newData;\n        // Re-render the category row.\n        const categoryRow = this.categoryElement.querySelector('[data-region=\"resource-category-row\"]');\n        if (categoryRow) {\n            Templates.render('mod_bookit/resource_category_row', newData)\n                .then(html => {\n                    const wrapper = document.createElement('tbody');\n                    wrapper.innerHTML = html.trim();\n                    const newRow = wrapper.firstChild;\n                    categoryRow.parentNode.replaceChild(newRow, categoryRow);\n                    this._attachEventListeners();\n                    return true;\n                })\n                .catch(error => {\n                    window.console.error('Error updating category row:', error);\n                });\n        }\n    }\n\n    /**\n     * Remove from DOM.\n     */\n    remove() {\n        this.itemComponents.forEach(component => component.remove());\n        this.itemComponents.clear();\n\n        if (this.categoryElement && this.categoryElement.parentNode) {\n            this.categoryElement.parentNode.removeChild(this.categoryElement);\n        }\n    }\n}\n"],"names":["ResourceCategory","BaseComponent","componentName","create","element","categoryData","categoryElement","itemComponents","Map","parentElement","getWatchers","watch","handler","this","_handleItemCreated","_handleItemCategoryChanged","_handleItemDeleted","categoryRowHtml","Templates","render","tbody","document","createElement","dataset","region","categoryid","id","categoryName","name","categoryDescription","description","categorySortorder","sortorder","innerHTML","trim","appendChild","_renderItems","_attachEventListeners","categoryRow","querySelector","clear","state","reactive","items","Array","from","values","filter","item","sort","a","b","itemData","itemComponent","ResourceItem","_render","set","_initItemsFromDOM","querySelectorAll","forEach","itemRow","itemId","parseInt","get","itemElement","has","component","remove","delete","addBtn","addEventListener","e","preventDefault","_handleAddItem","editBtn","_handleEdit","modalForm","ModalForm","formClass","args","modalConfig","title","events","FORM_SUBMITTED","dispatch","detail","show","moduleName","stateManager","processUpdates","LOADED","modal","getRoot","find","on","async","length","errorTitle","errorMessage","alert","confirmTitle","confirmMessage","deleteText","deleteCancel","getFormNode","value","submitFormAjax","update","newData","then","html","wrapper","newRow","firstChild","parentNode","replaceChild","catch","error","window","console","removeChild"],"mappings":"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"}