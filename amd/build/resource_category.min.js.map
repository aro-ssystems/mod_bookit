{"version":3,"file":"resource_category.min.js","sources":["../src/resource_category.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Resource category reactive component.\n *\n * @module mod_bookit/resource_category\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {BaseComponent} from 'core/reactive';\nimport Templates from 'core/templates';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport Notification from 'core/notification';\nimport ResourceItem from './resource_item';\n\n/**\n * Resource category component.\n */\nexport default class ResourceCategory extends BaseComponent {\n    /**\n     * Component descriptor for debugging.\n     *\n     * @return {string} Component name\n     */\n    static get componentName() {\n        return 'mod_bookit/resource_category';\n    }\n\n    /**\n     * Create component.\n     *\n     * @param {Object} options - Component options\n     * @param {HTMLElement} options.element - Parent container element\n     * @param {Object} options.categoryData - Category data\n     */\n    create({element, categoryData}) {\n        this.categoryData = categoryData;\n        this.categoryElement = null;\n        this.itemComponents = new Map();\n        this.parentElement = element;\n\n        // Render immediately.\n        this._render();\n    }\n\n    /**\n     * Get state watchers.\n     *\n     * @return {Array} Array of watcher definitions\n     */\n    getWatchers() {\n        return [\n            {watch: `items:created`, handler: this._handleItemCreated},\n            {watch: `items:updated`, handler: this._handleItemUpdated},\n            {watch: `items:deleted`, handler: this._handleItemDeleted},\n        ];\n    }\n\n    /**\n     * Render category.\n     */\n    async _render() {\n        const context = {\n            ...this.categoryData,\n            resources: [], // JS renders items.\n        };\n\n        const html = await Templates.render('mod_bookit/resource_category_card', context);\n\n        const wrapper = document.createElement('div');\n        wrapper.innerHTML = html.trim();\n        this.categoryElement = wrapper.firstChild;\n\n        this.parentElement.appendChild(this.categoryElement);\n\n        this._renderItems();\n        this._attachEventListeners();\n    }\n\n    /**\n     * Render items in this category.\n     */\n    _renderItems() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        const itemsContainer = this.categoryElement.querySelector('[data-region=\"items-container\"]');\n        if (!itemsContainer) {\n            return;\n        }\n\n        // Clear existing.\n        itemsContainer.innerHTML = '';\n        this.itemComponents.clear();\n\n        // Get items from state.\n        const state = this.reactive.state;\n        const items = Array.from(state.items.values())\n            .filter(item => item.categoryid === this.categoryData.id)\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Render each item.\n        items.forEach(itemData => {\n            const itemComponent = new ResourceItem({\n                element: itemsContainer,\n                reactive: this.reactive,\n                itemData: itemData,\n            });\n            this.itemComponents.set(itemData.id, itemComponent);\n        });\n\n        // Show/hide no items message.\n        this._updateNoItemsMessage(items.length === 0);\n    }\n\n    /**\n     * Update no items message visibility.\n     *\n     * @param {boolean} show - Whether to show\n     */\n    _updateNoItemsMessage(show) {\n        const msg = this.categoryElement.querySelector('[data-region=\"no-items\"]');\n        if (msg) {\n            if (show) {\n                msg.classList.remove('d-none');\n            } else {\n                msg.classList.add('d-none');\n            }\n        }\n    }\n\n    /**\n     * Handle item created.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - New item data\n     */\n    _handleItemCreated({element}) {\n        if (element.categoryid === this.categoryData.id) {\n            this._renderItems();\n        }\n    }\n\n    /**\n     * Handle item updated.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Updated item data\n     */\n    _handleItemUpdated({element}) {\n        // Check if item moved to/from this category.\n        const hadItem = this.itemComponents.has(element.id);\n        const shouldHaveItem = element.categoryid === this.categoryData.id;\n\n        if (hadItem !== shouldHaveItem) {\n            // Item moved - re-render.\n            this._renderItems();\n        } else if (shouldHaveItem) {\n            // Item updated in place.\n            const component = this.itemComponents.get(element.id);\n            if (component) {\n                component.update(element);\n            }\n        }\n    }\n\n    /**\n     * Handle item deleted.\n     *\n     * @param {Object} args - Event args\n     * @param {Object} args.element - Deleted item data\n     */\n    _handleItemDeleted({element}) {\n        const component = this.itemComponents.get(element.id);\n        if (component) {\n            component.remove();\n            this.itemComponents.delete(element.id);\n\n            // Update no items message.\n            const state = this.reactive.state;\n            const remainingItems = Array.from(state.items.values())\n                .filter(item => item.categoryid === this.categoryData.id);\n            this._updateNoItemsMessage(remainingItems.length === 0);\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    _attachEventListeners() {\n        if (!this.categoryElement) {\n            return;\n        }\n\n        // Add Item.\n        const addBtn = this.categoryElement.querySelector('[data-action=\"add-item\"]');\n        if (addBtn) {\n            addBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this._handleAddItem();\n            });\n        }\n\n        // Edit Category.\n        const editBtn = this.categoryElement.querySelector('[data-action=\"edit-category\"]');\n        if (editBtn) {\n            editBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this._handleEdit();\n            });\n        }\n    }\n\n    /**\n     * Handle add item.\n     */\n    async _handleAddItem() {\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\form\\\\edit_resource_form',\n            args: {\n                categoryid: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await getString('resources:add_resource', 'mod_bookit'),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.dispatch('createItem', e.detail);\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Handle edit category.\n     */\n    async _handleEdit() {\n        const modalForm = new ModalForm({\n            formClass: 'mod_bookit\\\\form\\\\edit_resource_category_form',\n            moduleName: 'mod_bookit/modal_delete_save_cancel',\n            args: {\n                id: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await getString('resources:edit_category', 'mod_bookit'),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.stateManager.processUpdates(e.detail);\n        });\n\n        modalForm.addEventListener(modalForm.events.LOADED, () => {\n            const deleteButton = modalForm.modal.getRoot().find('button[data-action=\"delete\"]');\n\n            deleteButton.on('click', async(e) => {\n                e.preventDefault();\n\n                // Check if category has resources.\n                const state = this.reactive.state;\n                const resourceCount = Array.from(state.items.values())\n                    .filter(item => item.categoryid === this.categoryData.id).length;\n\n                if (resourceCount > 0) {\n                    // Category has resources - show informative message.\n                    const errorTitle = await getString('error', 'core');\n                    const errorMessage = await getString('resources:category_has_resources', 'mod_bookit');\n\n                    Notification.alert(\n                        errorTitle,\n                        errorMessage\n                    );\n                    return;\n                }\n\n                // No resources - proceed with delete confirmation.\n                const confirmTitle = await getString('confirm', 'core');\n                const confirmMessage = await getString('areyousure', 'core');\n                const deleteText = await getString('delete', 'core');\n\n                Notification.deleteCancel(\n                    confirmTitle,\n                    confirmMessage,\n                    deleteText,\n                    () => {\n                        modalForm.getFormNode().querySelector('input[name=\"action\"]').value = 'delete';\n                        modalForm.submitFormAjax();\n                    }\n                );\n            });\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Update with new data.\n     *\n     * @param {Object} newData - Updated category data\n     */\n    update(newData) {\n        this.categoryData = newData;\n        // Update header text if needed.\n        const header = this.categoryElement.querySelector('h5');\n        if (header) {\n            header.textContent = newData.name;\n        }\n        const desc = this.categoryElement.querySelector('.text-muted');\n        if (desc) {\n            desc.textContent = newData.description || '';\n        }\n    }\n\n    /**\n     * Remove from DOM.\n     */\n    remove() {\n        this.itemComponents.forEach(component => component.remove());\n        this.itemComponents.clear();\n\n        if (this.categoryElement && this.categoryElement.parentNode) {\n            this.categoryElement.parentNode.removeChild(this.categoryElement);\n        }\n    }\n}\n"],"names":["ResourceCategory","BaseComponent","componentName","create","element","categoryData","categoryElement","itemComponents","Map","parentElement","_render","getWatchers","watch","handler","this","_handleItemCreated","_handleItemUpdated","_handleItemDeleted","context","resources","html","Templates","render","wrapper","document","createElement","innerHTML","trim","firstChild","appendChild","_renderItems","_attachEventListeners","itemsContainer","querySelector","clear","state","reactive","items","Array","from","values","filter","item","categoryid","id","sort","a","b","sortorder","forEach","itemData","itemComponent","ResourceItem","set","_updateNoItemsMessage","length","show","msg","classList","remove","add","hadItem","has","shouldHaveItem","component","get","update","delete","remainingItems","addBtn","addEventListener","e","preventDefault","_handleAddItem","editBtn","_handleEdit","modalForm","ModalForm","formClass","args","modalConfig","title","events","FORM_SUBMITTED","dispatch","detail","moduleName","stateManager","processUpdates","LOADED","modal","getRoot","find","on","async","errorTitle","errorMessage","alert","confirmTitle","confirmMessage","deleteText","deleteCancel","getFormNode","value","submitFormAjax","newData","header","textContent","name","desc","description","parentNode","removeChild"],"mappings":"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"}