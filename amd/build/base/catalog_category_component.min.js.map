{"version":3,"file":"catalog_category_component.min.js","sources":["../../src/base/catalog_category_component.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Base component for catalog categories.\n *\n * @module mod_bookit/base/catalog_category_component\n * @copyright   2026 ssystems GmbH <oss@ssystems.de>\n * @author      Andreas Rosenthal\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Base class for catalog category components.\n */\nexport default class CatalogCategoryComponent {\n    /**\n     * Constructor.\n     *\n     * @param {Object} reactive - Reactive store instance\n     * @param {Object} categoryData - Category data from state\n     * @param {Function} ItemComponentClass - Item component class constructor\n     */\n    constructor(reactive, categoryData, ItemComponentClass) {\n        this.reactive = reactive;\n        this.categoryData = categoryData;\n        this.ItemComponentClass = ItemComponentClass;\n        this.element = null;\n        this.itemComponents = new Map();\n    }\n\n    /**\n     * Render the category to a DOM element.\n     *\n     * @return {Promise<HTMLElement>} Rendered element\n     */\n    async render() {\n        const context = this.getTemplateContext();\n        const html = await Templates.render(this.getTemplateName(), context);\n\n        const wrapper = document.createElement('div');\n        wrapper.innerHTML = html.trim();\n        this.element = wrapper.firstChild;\n\n        await this.renderItems();\n        this.attachEventListeners();\n        this.attachDragDropListeners();\n\n        return this.element;\n    }\n\n    /**\n     * Get template name for rendering.\n     *\n     * ABSTRACT - Must be implemented by subclass.\n     *\n     * @return {string} Template name\n     */\n    getTemplateName() {\n        throw new Error('getTemplateName() must be implemented by subclass');\n    }\n\n    /**\n     * Get template context data.\n     *\n     * @return {Object} Context for template\n     */\n    getTemplateContext() {\n        return {\n            ...this.categoryData,\n            resources: [], // Empty - JS renders.\n        };\n    }\n\n    /**\n     * Get the form class name for editing category.\n     *\n     * ABSTRACT - Must be implemented by subclass.\n     *\n     * @return {string} Form class name\n     */\n    getEditModalFormClass() {\n        throw new Error('getEditModalFormClass() must be implemented by subclass');\n    }\n\n    /**\n     * Render items in this category.\n     */\n    async renderItems() {\n        if (!this.element) {\n            return;\n        }\n\n        const itemsContainer = this.element.querySelector('[data-region=\"items-container\"]');\n        if (!itemsContainer) {\n            return;\n        }\n\n        // Clear existing items.\n        itemsContainer.innerHTML = '';\n        this.itemComponents.clear();\n\n        // Get items from reactive state.\n        const state = this.reactive.state;\n        const items = Array.from(state.items.values())\n            .filter(item => item.categoryid === this.categoryData.id)\n            .sort((a, b) => a.sortorder - b.sortorder);\n\n        // Render each item.\n        for (const itemData of items) {\n            const itemComponent = new this.ItemComponentClass(this.reactive, itemData);\n            const itemElement = await itemComponent.render();\n            itemsContainer.appendChild(itemElement);\n            this.itemComponents.set(itemData.id, itemComponent);\n        }\n\n        // Show/hide no items message.\n        this.updateNoItemsMessage(items.length === 0);\n    }\n\n    /**\n     * Update no items message visibility.\n     *\n     * @param {boolean} show - Whether to show the message\n     */\n    updateNoItemsMessage(show) {\n        const noItemsMsg = this.element.querySelector('[data-region=\"no-items\"]');\n        if (noItemsMsg) {\n            if (show) {\n                noItemsMsg.classList.remove('d-none');\n            } else {\n                noItemsMsg.classList.add('d-none');\n            }\n        }\n    }\n\n    /**\n     * Attach event listeners.\n     */\n    attachEventListeners() {\n        if (!this.element) {\n            return;\n        }\n\n        // Add Item button.\n        const addItemBtn = this.element.querySelector('[data-action=\"add-item\"]');\n        if (addItemBtn) {\n            addItemBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this.handleAddItem();\n            });\n        }\n\n        // Edit Category button.\n        const editBtn = this.element.querySelector('[data-action=\"edit-category\"]');\n        if (editBtn) {\n            editBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this.handleEdit();\n            });\n        }\n\n        // Delete Category button.\n        const deleteBtn = this.element.querySelector('[data-action=\"delete-category\"]');\n        if (deleteBtn) {\n            deleteBtn.addEventListener('click', (e) => {\n                e.preventDefault();\n                this.handleDelete();\n            });\n        }\n    }\n\n    /**\n     * Attach drag and drop listeners.\n     */\n    attachDragDropListeners() {\n        if (!this.element) {\n            return;\n        }\n\n        // Category header draggable.\n        const header = this.element.querySelector('[data-region=\"category-header\"]');\n        if (header) {\n            header.setAttribute('draggable', 'true');\n            header.classList.add('draggable-category');\n\n            header.addEventListener('dragstart', (e) => {\n                e.dataTransfer.effectAllowed = 'move';\n                e.dataTransfer.setData('application/x-bookit-category-id', this.categoryData.id);\n                this.element.classList.add('dragging');\n            });\n\n            header.addEventListener('dragend', () => {\n                this.element.classList.remove('dragging');\n            });\n\n            header.addEventListener('dragover', (e) => {\n                e.preventDefault();\n                e.dataTransfer.dropEffect = 'move';\n            });\n\n            header.addEventListener('drop', (e) => {\n                e.preventDefault();\n                const draggedCategoryId = parseInt(\n                    e.dataTransfer.getData('application/x-bookit-category-id'),\n                    10\n                );\n                if (draggedCategoryId && draggedCategoryId !== this.categoryData.id) {\n                    this.handleReorder(draggedCategoryId, this.categoryData.id);\n                }\n            });\n        }\n\n        // Items container - allow drop from other categories.\n        const itemsContainer = this.element.querySelector('[data-region=\"items-container\"]');\n        if (itemsContainer) {\n            itemsContainer.addEventListener('dragover', (e) => {\n                e.preventDefault();\n                e.dataTransfer.dropEffect = 'move';\n            });\n\n            itemsContainer.addEventListener('drop', (e) => {\n                e.preventDefault();\n                const itemId = parseInt(e.dataTransfer.getData('application/x-bookit-item-id'), 10);\n                if (itemId) {\n                    // Move item to this category.\n                    this.handleItemMovedToCategory(itemId);\n                }\n            });\n        }\n    }\n\n    /**\n     * Handle add item action.\n     */\n    async handleAddItem() {\n        const ItemComponentClass = this.ItemComponentClass;\n        const instance = new ItemComponentClass(this.reactive, {categoryid: this.categoryData.id});\n        const modalForm = new ModalForm({\n            formClass: instance.getEditModalFormClass(),\n            args: {\n                id: 0,\n                categoryid: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await this.getAddItemModalTitle(),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.dispatch('createItem', e.detail);\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Get add item modal title.\n     *\n     * @return {Promise<string>} Modal title\n     */\n    async getAddItemModalTitle() {\n        return getString('resources:add_resource', 'mod_bookit');\n    }\n\n    /**\n     * Handle edit category action.\n     */\n    async handleEdit() {\n        const modalForm = new ModalForm({\n            formClass: this.getEditModalFormClass(),\n            args: {\n                id: this.categoryData.id,\n            },\n            modalConfig: {\n                title: await this.getEditModalTitle(),\n            },\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n            this.reactive.dispatch('updateCategory', e.detail);\n        });\n\n        modalForm.show();\n    }\n\n    /**\n     * Get edit modal title.\n     *\n     * @return {Promise<string>} Modal title\n     */\n    async getEditModalTitle() {\n        return getString('resources:edit_category', 'mod_bookit');\n    }\n\n    /**\n     * Handle delete category action.\n     */\n    async handleDelete() {\n        const message = await getString('resources:confirm_delete_category', 'mod_bookit', this.categoryData.name);\n        // Use eslint-disable for window.confirm as it's acceptable in Moodle context.\n        // eslint-disable-next-line no-alert\n        const confirmed = window.confirm(message);\n\n        if (confirmed) {\n            this.reactive.dispatch('deleteCategory', this.categoryData.id);\n        }\n    }\n\n    /**\n     * Handle category reorder.\n     *\n     * @param {number} draggedCategoryId - ID of dragged category\n     * @param {number} targetCategoryId - ID of target category\n     */\n    handleReorder(draggedCategoryId, targetCategoryId) {\n        this.reactive.dispatch('reorderCategory', {\n            categoryId: draggedCategoryId,\n            targetCategoryId: targetCategoryId,\n        });\n    }\n\n    /**\n     * Handle item moved to this category.\n     *\n     * @param {number} itemId - ID of item\n     */\n    handleItemMovedToCategory(itemId) {\n        const state = this.reactive.state;\n        const item = state.items.get(itemId);\n\n        if (item && item.categoryid !== this.categoryData.id) {\n            // Update item's category.\n            this.reactive.dispatch('updateItem', {\n                ...item,\n                categoryid: this.categoryData.id,\n            });\n        }\n    }\n\n    /**\n     * Update the element with new data.\n     *\n     * @param {Object} newData - Updated category data\n     */\n    update(newData) {\n        this.categoryData = newData;\n        if (this.element && this.element.parentNode) {\n            return this.render().then(newElement => {\n                this.element.parentNode.replaceChild(newElement, this.element);\n                return newElement;\n            }).catch((error) => {\n                window.console.error('Error updating category:', error);\n                throw error;\n            });\n        }\n        return Promise.resolve();\n    }\n\n    /**\n     * Remove the element from DOM.\n     */\n    remove() {\n        // Remove all item components.\n        this.itemComponents.forEach(component => component.remove());\n        this.itemComponents.clear();\n\n        if (this.element && this.element.parentNode) {\n            this.element.parentNode.removeChild(this.element);\n        }\n    }\n}\n"],"names":["constructor","reactive","categoryData","ItemComponentClass","element","itemComponents","Map","context","this","getTemplateContext","html","Templates","render","getTemplateName","wrapper","document","createElement","innerHTML","trim","firstChild","renderItems","attachEventListeners","attachDragDropListeners","Error","resources","getEditModalFormClass","itemsContainer","querySelector","clear","state","items","Array","from","values","filter","item","categoryid","id","sort","a","b","sortorder","itemData","itemComponent","itemElement","appendChild","set","updateNoItemsMessage","length","show","noItemsMsg","classList","remove","add","addItemBtn","addEventListener","e","preventDefault","handleAddItem","editBtn","handleEdit","deleteBtn","handleDelete","header","setAttribute","dataTransfer","effectAllowed","setData","dropEffect","draggedCategoryId","parseInt","getData","handleReorder","itemId","handleItemMovedToCategory","instance","modalForm","ModalForm","formClass","args","modalConfig","title","getAddItemModalTitle","events","FORM_SUBMITTED","dispatch","detail","getEditModalTitle","message","name","window","confirm","targetCategoryId","categoryId","get","update","newData","parentNode","then","newElement","replaceChild","catch","error","console","Promise","resolve","forEach","component","removeChild"],"mappings":";;;;;;;;+MAuCIA,YAAYC,SAAUC,aAAcC,yBAC3BF,SAAWA,cACXC,aAAeA,kBACfC,mBAAqBA,wBACrBC,QAAU,UACVC,eAAiB,IAAIC,yBASpBC,QAAUC,KAAKC,qBACfC,WAAaC,mBAAUC,OAAOJ,KAAKK,kBAAmBN,SAEtDO,QAAUC,SAASC,cAAc,cACvCF,QAAQG,UAAYP,KAAKQ,YACpBd,QAAUU,QAAQK,iBAEjBX,KAAKY,mBACNC,4BACAC,0BAEEd,KAAKJ,QAUhBS,wBACU,IAAIU,MAAM,qDAQpBd,2BACW,IACAD,KAAKN,aACRsB,UAAW,IAWnBC,8BACU,IAAIF,MAAM,mFAOXf,KAAKJ,qBAIJsB,eAAiBlB,KAAKJ,QAAQuB,cAAc,uCAC7CD,sBAKLA,eAAeT,UAAY,QACtBZ,eAAeuB,cAGdC,MAAQrB,KAAKP,SAAS4B,MACtBC,MAAQC,MAAMC,KAAKH,MAAMC,MAAMG,UAChCC,QAAOC,MAAQA,KAAKC,aAAe5B,KAAKN,aAAamC,KACrDC,MAAK,CAACC,EAAGC,IAAMD,EAAEE,UAAYD,EAAEC,gBAG/B,MAAMC,YAAYZ,MAAO,OACpBa,cAAgB,IAAInC,KAAKL,mBAAmBK,KAAKP,SAAUyC,UAC3DE,kBAAoBD,cAAc/B,SACxCc,eAAemB,YAAYD,kBACtBvC,eAAeyC,IAAIJ,SAASL,GAAIM,oBAIpCI,qBAAsC,IAAjBjB,MAAMkB,QAQpCD,qBAAqBE,YACXC,WAAa1C,KAAKJ,QAAQuB,cAAc,4BAC1CuB,aACID,KACAC,WAAWC,UAAUC,OAAO,UAE5BF,WAAWC,UAAUE,IAAI,WAQrChC,2BACSb,KAAKJ,qBAKJkD,WAAa9C,KAAKJ,QAAQuB,cAAc,4BAC1C2B,YACAA,WAAWC,iBAAiB,SAAUC,IAClCA,EAAEC,sBACGC,yBAKPC,QAAUnD,KAAKJ,QAAQuB,cAAc,iCACvCgC,SACAA,QAAQJ,iBAAiB,SAAUC,IAC/BA,EAAEC,sBACGG,sBAKPC,UAAYrD,KAAKJ,QAAQuB,cAAc,mCACzCkC,WACAA,UAAUN,iBAAiB,SAAUC,IACjCA,EAAEC,sBACGK,kBAQjBxC,8BACSd,KAAKJ,qBAKJ2D,OAASvD,KAAKJ,QAAQuB,cAAc,mCACtCoC,SACAA,OAAOC,aAAa,YAAa,QACjCD,OAAOZ,UAAUE,IAAI,sBAErBU,OAAOR,iBAAiB,aAAcC,IAClCA,EAAES,aAAaC,cAAgB,OAC/BV,EAAES,aAAaE,QAAQ,mCAAoC3D,KAAKN,aAAamC,SACxEjC,QAAQ+C,UAAUE,IAAI,eAG/BU,OAAOR,iBAAiB,WAAW,UAC1BnD,QAAQ+C,UAAUC,OAAO,eAGlCW,OAAOR,iBAAiB,YAAaC,IACjCA,EAAEC,iBACFD,EAAES,aAAaG,WAAa,UAGhCL,OAAOR,iBAAiB,QAASC,IAC7BA,EAAEC,uBACIY,kBAAoBC,SACtBd,EAAES,aAAaM,QAAQ,oCACvB,IAEAF,mBAAqBA,oBAAsB7D,KAAKN,aAAamC,SACxDmC,cAAcH,kBAAmB7D,KAAKN,aAAamC,cAM9DX,eAAiBlB,KAAKJ,QAAQuB,cAAc,mCAC9CD,iBACAA,eAAe6B,iBAAiB,YAAaC,IACzCA,EAAEC,iBACFD,EAAES,aAAaG,WAAa,UAGhC1C,eAAe6B,iBAAiB,QAASC,IACrCA,EAAEC,uBACIgB,OAASH,SAASd,EAAES,aAAaM,QAAQ,gCAAiC,IAC5EE,aAEKC,0BAA0BD,wCAWrCE,SAAW,IAAIxE,EADMK,KAAKL,oBACQK,KAAKP,SAAU,CAACmC,WAAY5B,KAAKN,aAAamC,KAChFuC,UAAY,IAAIC,mBAAU,CAC5BC,UAAWH,SAASlD,wBACpBsD,KAAM,CACF1C,GAAI,EACJD,WAAY5B,KAAKN,aAAamC,IAElC2C,YAAa,CACTC,YAAazE,KAAK0E,0BAI1BN,UAAUrB,iBAAiBqB,UAAUO,OAAOC,gBAAiB5B,SACpDvD,SAASoF,SAAS,aAAc7B,EAAE8B,WAG3CV,UAAU3B,2CASH,mBAAU,yBAA0B,uCAOrC2B,UAAY,IAAIC,mBAAU,CAC5BC,UAAWtE,KAAKiB,wBAChBsD,KAAM,CACF1C,GAAI7B,KAAKN,aAAamC,IAE1B2C,YAAa,CACTC,YAAazE,KAAK+E,uBAI1BX,UAAUrB,iBAAiBqB,UAAUO,OAAOC,gBAAiB5B,SACpDvD,SAASoF,SAAS,iBAAkB7B,EAAE8B,WAG/CV,UAAU3B,wCASH,mBAAU,0BAA2B,yCAOtCuC,cAAgB,mBAAU,oCAAqC,aAAchF,KAAKN,aAAauF,MAGnFC,OAAOC,QAAQH,eAGxBvF,SAASoF,SAAS,iBAAkB7E,KAAKN,aAAamC,IAUnEmC,cAAcH,kBAAmBuB,uBACxB3F,SAASoF,SAAS,kBAAmB,CACtCQ,WAAYxB,kBACZuB,iBAAkBA,mBAS1BlB,0BAA0BD,cAEhBtC,KADQ3B,KAAKP,SAAS4B,MACTC,MAAMgE,IAAIrB,QAEzBtC,MAAQA,KAAKC,aAAe5B,KAAKN,aAAamC,SAEzCpC,SAASoF,SAAS,aAAc,IAC9BlD,KACHC,WAAY5B,KAAKN,aAAamC,KAU1C0D,OAAOC,qBACE9F,aAAe8F,QAChBxF,KAAKJ,SAAWI,KAAKJ,QAAQ6F,WACtBzF,KAAKI,SAASsF,MAAKC,kBACjB/F,QAAQ6F,WAAWG,aAAaD,WAAY3F,KAAKJ,SAC/C+F,cACRE,OAAOC,cACNZ,OAAOa,QAAQD,MAAM,2BAA4BA,OAC3CA,SAGPE,QAAQC,UAMnBrD,cAES/C,eAAeqG,SAAQC,WAAaA,UAAUvD,gBAC9C/C,eAAeuB,QAEhBpB,KAAKJ,SAAWI,KAAKJ,QAAQ6F,iBACxB7F,QAAQ6F,WAAWW,YAAYpG,KAAKJ"}